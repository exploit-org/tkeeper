package org.exploit.keeper.service.gg20

import jakarta.inject.Singleton
import org.exploit.keeper.config.KeeperConfig
import org.exploit.keeper.constant.SessionType
import org.exploit.keeper.model.common.Value
import org.exploit.keeper.model.event.SessionCleanEvent
import org.exploit.signalix.manager.EventScope
import java.math.BigInteger

@Singleton
class GG20SignaturePartHandler(
    private val config: KeeperConfig,
    private val eventScope: EventScope,
    private val factory: GG20SessionFactory
) {
    fun computePartialS(sessionId: String, finalize: Boolean = false): Value<BigInteger> {
        val result = factory.session(sessionId)
            .signature()
            .computePartialS()
            .let { Value(config.idx(), it) }

        if (finalize) {
            eventScope.call(SessionCleanEvent(sessionId, SessionType.GG20))
        }

        return result
    }
}