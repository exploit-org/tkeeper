package org.exploit.keeper.service.expire

import jakarta.inject.Singleton
import org.exploit.keeper.constant.expire.ExpireType
import org.exploit.keeper.db.RocksKeyDB
import org.exploit.keeper.model.Page
import org.exploit.keeper.model.expire.ExpireItem
import org.exploit.keeper.service.core.KeeperService
import java.time.Instant

@Singleton
class KeeperExpireService(private val db: RocksKeyDB, private val keeper: KeeperService) {
    fun listExpiring(type: ExpireType, toEpochSec: Long, fromEpochSec: Long = 0, limit: Int = 500, cursor: String? = null): Page<ExpireItem, String> {
        keeper.ensureReady()

        val safeLimit = limit.coerceIn(1, 2000)
        val from = fromEpochSec.coerceAtLeast(0)
        val to = toEpochSec.coerceAtLeast(0)

        if (to < from) return Page(emptyList(), null)

        return db.expire.scan(
            type = type,
            fromEpochSec = from,
            toEpochSec = to,
            limit = safeLimit,
            cursor = cursor
        )
    }

    fun listExpiringWindow(type: ExpireType, windowSec: Long, limit: Int = 500, cursor: String? = null, nowEpochSec: Long = Instant.now().epochSecond): Page<ExpireItem, String> {
        val safeWindow = windowSec.coerceAtLeast(0)
        val to = nowEpochSec + safeWindow

        return listExpiring(
            type = type,
            fromEpochSec = 0,
            toEpochSec = to,
            limit = limit,
            cursor = cursor
        )
    }

    fun listApplyExpiringWindow(windowSec: Long, limit: Int = 500, cursor: String? = null, nowEpochSec: Long = Instant.now().epochSecond): Page<ExpireItem, String> =
        listExpiringWindow(
            type = ExpireType.APPLY,
            windowSec = windowSec,
            limit = limit,
            cursor = cursor,
            nowEpochSec = nowEpochSec
        )

    fun listProcessExpiringWindow(windowSec: Long, limit: Int = 500, cursor: String? = null, nowEpochSec: Long = Instant.now().epochSecond): Page<ExpireItem, String> =
        listExpiringWindow(
            type = ExpireType.PROCESS,
            windowSec = windowSec,
            limit = limit,
            cursor = cursor,
            nowEpochSec = nowEpochSec
        )

    fun listExpired(type: ExpireType, limit: Int = 500, cursor: String? = null, nowEpochSec: Long = Instant.now().epochSecond): Page<ExpireItem, String> =
        listExpiring(
            type = type,
            fromEpochSec = 0,
            toEpochSec = nowEpochSec,
            limit = limit,
            cursor = cursor
        )
}