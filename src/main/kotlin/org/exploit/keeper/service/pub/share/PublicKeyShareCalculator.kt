package org.exploit.keeper.service.pub.share

import jakarta.inject.Singleton
import org.exploit.keeper.constant.KeeperCurve
import org.exploit.keeper.db.RocksKeyDB
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.toBigInt
import org.exploit.keeper.extension.toPrivateKey
import org.exploit.keeper.extension.use
import org.exploit.keeper.model.key.PubKeyShare

@Singleton
class PublicKeyShareCalculator(private val db: RocksKeyDB) {
    private val initData by lazy {
        db.readInitData()
    }

    fun pubKeyShare(keyId: String): PubKeyShare<*> {
        val privateKey = db.storage.get(keyId)?.toPrivateKey()
            ?: throw TKeeperException(400, "Private Key not found or invalid for $keyId")

        return privateKey.ski.use {
            val curve = KeeperCurve.fromName(privateKey.curve)

            val point = curve.params.g.mul(it.toBigInt())
                .normalize()

            PubKeyShare(initData.peerId, curve.name, point)
        }
    }
}