package org.exploit.keeper.service.pub

import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.crypto.KeeperCurve
import org.exploit.keeper.db.RocksKeyDB
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.crypto.toBigInt
import org.exploit.keeper.extension.toPrivateKey
import org.exploit.keeper.extension.use
import org.exploit.keeper.model.key.PubKeyShare
import org.exploit.keeper.util.TKeeperTweak

@Singleton
class PublicKeyShareCalculator(private val db: RocksKeyDB) {
    private val initData by lazy {
        db.readInitData()
    }

    fun pubKeyShare(keyId: String, version: Int, tweak: String?): PubKeyShare<*> {
        val privateKey = db.vault.readKey(keyId, version)?.toPrivateKey()
            ?: throw TKeeperException(ErrorType.KEY_NOT_FOUND, keyId)

        return privateKey.ski.use {
            val curve = KeeperCurve.fromName(privateKey.curve)

            val tweaked = if (tweak.isNullOrBlank()) it.toBigInt() else {
                TKeeperTweak.tweak(it.toBigInt(), keyId.toByteArray(), curve.name, tweak, curve.params.curveOrder)
            }

            val point = curve.params.g.mul(tweaked)
                .normalize()

            PubKeyShare(initData.peerId, curve.name, point)
        }
    }
}