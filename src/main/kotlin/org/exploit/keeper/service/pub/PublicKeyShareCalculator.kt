package org.exploit.keeper.service.pub

import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.crypto.KeeperCurve
import org.exploit.keeper.db.RocksKeyDB
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.crypto.toBigInt
import org.exploit.keeper.extension.toPrivateKey
import org.exploit.keeper.extension.use
import org.exploit.keeper.model.key.PubKeyShare

@Singleton
class PublicKeyShareCalculator(private val db: RocksKeyDB) {
    private val initData by lazy {
        db.readInitData()
    }

    fun pubKeyShare(keyId: String, version: Int): PubKeyShare<*> {
        val privateKey = db.vault.readKey(keyId, version)?.toPrivateKey()
            ?: throw TKeeperException(ErrorType.KEY_NOT_FOUND, keyId)

        return privateKey.ski.use {
            val curve = KeeperCurve.fromName(privateKey.curve)

            val point = curve.params.g.mul(it.toBigInt())
                .normalize()

            PubKeyShare(initData.peerId, curve.name, point)
        }
    }
}