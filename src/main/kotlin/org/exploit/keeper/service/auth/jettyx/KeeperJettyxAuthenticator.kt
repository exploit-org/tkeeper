package org.exploit.keeper.service.auth.jettyx

import org.eclipse.jetty.client.api.Request
import org.exploit.jettyx.auth.Authorization
import org.exploit.keeper.db.RocksKeyDB
import org.exploit.keeper.extension.crypto.toBase64
import org.exploit.keeper.extension.http.toQueryMap
import org.exploit.keeper.service.boot.KeeperBootService
import org.exploit.keeper.service.integrity.KeeperSignatureService
import java.time.Instant
import java.util.*

class KeeperJettyxAuthenticator(
    private val instanceId: Int,
    private val db: RocksKeyDB,
    private val signer: KeeperSignatureService,
    private val bootProof: KeeperBootService
): Authorization {
    private val initData by lazy {
        db.readInitData()
    }

    override fun apply(request: Request) {
        val path = request.path
        val query = request.query?.toQueryMap() ?: emptyMap()
        val ts = Instant.now().toEpochMilli()
        val nonce = UUID.randomUUID().toString()

        val bootData = bootProof.prepare(instanceId, ts, nonce)

        val hash = signer.hashForSigning(
            instanceId = initData.peerId,
            intendedFor = instanceId,
            path = path,
            query = query,
            timestamp = ts,
            nonce = nonce,
            kid64 = bootData.kid64,
            proof64 = bootData.bootProof64
        )

        val signature = signer.sign(hash)
            .toBase64()

        request.headers {
            it.put(KeeperSignatureService.HEADER_INSTANCE_ID, initData.peerId.toString())
            it.put(KeeperSignatureService.HEADER_TIMESTAMP, ts.toString())
            it.put(KeeperSignatureService.HEADER_NONCE, nonce)
            it.put(KeeperSignatureService.HEADER_INTENDED_FOR, instanceId.toString())
            it.put(KeeperSignatureService.HEADER_SIGNATURE, signature)
            it.put(KeeperSignatureService.HEADER_KID, bootData.kid64)
            it.put(KeeperSignatureService.HEADER_PUBLIC_KEY, bootData.publicKey64)
            it.put(KeeperSignatureService.HEADER_BOOT_PROOF, bootData.bootProof64)
        }
    }
}