package org.exploit.keeper.service.dev

import com.linecorp.armeria.common.HttpRequest
import com.linecorp.armeria.common.HttpResponse
import com.linecorp.armeria.server.DecoratingHttpServiceFunction
import com.linecorp.armeria.server.HttpService
import com.linecorp.armeria.server.ServiceRequestContext
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.exception.TKeeperException
import java.net.InetSocketAddress

object EnsureLoopbackAddress : DecoratingHttpServiceFunction {
    override fun serve(delegate: HttpService, ctx: ServiceRequestContext, req: HttpRequest): HttpResponse {
        val local = (ctx.localAddress() as? InetSocketAddress)?.address
            ?: return delegate.serve(ctx, req)
        val remote = (ctx.remoteAddress() as? InetSocketAddress)?.address
            ?: return delegate.serve(ctx, req)

        if (local.isLoopbackAddress && remote.isLoopbackAddress) {
            return delegate.serve(ctx, req)
        }

        throw TKeeperException(ErrorType.DEV_MODE_VIOLATION, "Access from non-loopback address is not allowed in dev mode.")
    }
}