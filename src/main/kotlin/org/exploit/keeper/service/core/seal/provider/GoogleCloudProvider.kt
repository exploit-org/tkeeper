package org.exploit.keeper.service.core.seal.provider

import org.exploit.keeper.config.seal.GoogleProviderConfig
import org.exploit.keeper.exception.AutoProviderException
import org.exploit.keeper.model.seal.init.SealInitData
import org.exploit.keeper.model.seal.progress.Progress
import org.exploit.keeper.model.seal.progress.ReadyProgress
import org.exploit.keeper.service.key.GoogleKmsOps
import org.exploit.keeper.service.key.KeyOps
import java.util.concurrent.atomic.AtomicReference

class GoogleCloudProvider(private val config: GoogleProviderConfig): SealProvider {
    override val id: String = ID
    override val isAuto: Boolean = true

    private val keyOps = AtomicReference(GoogleKmsOps(config))

    override fun keyOpsOrNull(): KeyOps = GoogleKmsOps(config)

    override fun initialize(): SealInitData {
        throw AutoProviderException()
    }

    override fun submitPart(payload64: String): Progress {
        throw AutoProviderException()
    }

    override fun initialProgress(): Progress =
        ReadyProgress()

    override fun seal() {
        keyOps.set(null)
    }

    override fun unseal(): Progress {
        keyOps.set(GoogleKmsOps(config))
        return ReadyProgress()
    }

    companion object {
        const val ID = "google"
    }
}