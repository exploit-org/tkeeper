package org.exploit.keeper.service.core.seal.provider

import org.exploit.keeper.config.seal.GoogleProviderConfig
import org.exploit.keeper.model.seal.init.AutoInitData
import org.exploit.keeper.model.seal.init.SealInitData
import org.exploit.keeper.model.seal.progress.Progress
import org.exploit.keeper.model.seal.progress.ReadyProgress
import org.exploit.keeper.service.key.kek.GoogleKmsOps
import org.exploit.keeper.service.key.kek.KekOps
import java.util.concurrent.atomic.AtomicReference

class GoogleCloudProvider(private val config: GoogleProviderConfig): SealProvider {
    override val id: String = ID

    private val keyOps: AtomicReference<GoogleKmsOps> = AtomicReference()

    override fun kekOpsOrNull(): KekOps? = keyOps.get()

    override fun initialize(): SealInitData {
        return AutoInitData
    }

    override fun currentProgress(): Progress {
        return ReadyProgress(keyOps.get() != null)
    }

    override fun initialProgress(): Progress =
        ReadyProgress(keyOps.get() != null)

    override fun seal() {
        keyOps.set(null)
    }

    override fun unseal(): Progress {
        keyOps.set(GoogleKmsOps(config))
        return ReadyProgress()
    }

    companion object {
        const val ID = "google"
    }
}