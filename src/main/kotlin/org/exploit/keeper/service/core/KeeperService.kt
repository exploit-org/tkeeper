package org.exploit.keeper.service.core

import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.common.StoreState
import org.exploit.keeper.db.RocksKeyDB
import org.exploit.keeper.exception.NotInitializedException
import org.exploit.keeper.exception.SealedException
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.model.request.KeeperInitData
import org.exploit.keeper.model.seal.StatusResponse
import org.exploit.keeper.model.seal.init.SealInitData
import org.exploit.keeper.service.core.seal.SealManager

@Singleton
class KeeperService(
    private val db: RocksKeyDB,
    private val sealManager: SealManager
) {
    private val initData by lazy {
        db.readInitData()
    }

    fun peerId(): Int {
        if (!db.isInitialized())
            throw TKeeperException(ErrorType.KEEPER_NOT_INITIALIZED)

        return initData.peerId
    }

    fun initialize(initData: KeeperInitData): SealInitData {
        if (db.isInitialized())
            throw TKeeperException(ErrorType.KEEPER_ALREADY_INITIALIZED)

        return sealManager.initialize(initData)
    }

    fun status(): StatusResponse =
        sealManager.status()

    fun submit(payload64: String) =
        sealManager.submit(payload64)

    fun reset() {
        sealManager.seal()
    }

    fun unseal() {
        if (!db.isInitialized())
            throw NotInitializedException()

        sealManager.unseal()
    }

    fun seal() {
        if (!db.isInitialized())
            throw NotInitializedException()

        sealManager.seal()
    }

    fun initialized(): Boolean =
        db.isInitialized()

    fun sealed(): Boolean =
        sealManager.status().state == StoreState.SEALED

    fun ensureReady() {
        ensureInitialized()

        if (sealed())
            throw SealedException()
    }

    fun ensureInitialized() {
        if (!db.isInitialized())
            throw NotInitializedException()
    }
}