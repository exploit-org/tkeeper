package org.exploit.keeper.service.dkg

import jakarta.inject.Singleton
import org.exploit.keeper.api.client.TKeeperClient
import org.exploit.keeper.config.keeper.KeeperConfig
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.perform
import org.exploit.keeper.service.client.TKeeperClients
import org.slf4j.Logger
import org.slf4j.LoggerFactory

@Singleton
class DistributedKeyCollector(
    private val keyGen: DistributedKeyGen,
    private val peers: TKeeperClients,
    private val config: KeeperConfig,
) {
    fun collect(keyId: String, clients: List<TKeeperClient> = peers.findHealthy(config.peers.size)) {
        try {
            val shares = clients.perform { it.keyGen.share(keyId) }

            for (share in shares)
                keyGen.store(keyId, share)
        } catch (e: Exception) {
            LOGGER.error("Failed to collect shares for keyId=$keyId", e)
            throw TKeeperException(ErrorType.INTERNAL_ERROR, "Couldn't collect shares", e)
        }
    }

    private companion object {
        val LOGGER: Logger = LoggerFactory.getLogger(DistributedKeyCollector::class.java)
    }
}