package org.exploit.keeper.service.key.kek

import org.exploit.keeper.config.seal.AwsProviderConfig
import software.amazon.awssdk.core.SdkBytes
import software.amazon.awssdk.regions.Region
import software.amazon.awssdk.services.kms.KmsClient
import software.amazon.awssdk.services.kms.model.EncryptionAlgorithmSpec

class AwsKmsOps(private val config: AwsProviderConfig): KekOps {
    private val kms by lazy {
        KmsClient.builder()
            .region(Region.of(config.region))
            .build()
    }

    override fun wrapDek(dek: ByteArray): ByteArray {
        val encrypted = kms.encrypt {
            it.keyId(config.keyId)
                .plaintext(SdkBytes.fromByteArray(dek))
                .encryptionAlgorithm(EncryptionAlgorithmSpec.SYMMETRIC_DEFAULT)
                .build()
        }

        return encrypted.ciphertextBlob().asByteArray()
    }

    override fun unwrapDek(wrappedDek: ByteArray): ByteArray {
        val decrypted = kms.decrypt {
            it.ciphertextBlob(SdkBytes.fromByteArray(wrappedDek))
                .keyId(config.keyId)
                .encryptionAlgorithm(EncryptionAlgorithmSpec.SYMMETRIC_DEFAULT)
                .build()
        }

        return decrypted.plaintext().asByteArray()
    }
}