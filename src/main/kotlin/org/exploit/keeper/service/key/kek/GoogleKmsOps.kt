package org.exploit.keeper.service.key.kek

import com.google.cloud.kms.v1.CryptoKeyName
import com.google.cloud.kms.v1.KeyManagementServiceClient
import com.google.protobuf.ByteString
import org.exploit.keeper.config.seal.GoogleProviderConfig

class GoogleKmsOps(config: GoogleProviderConfig): KekOps {
    private val kms by lazy {
        KeyManagementServiceClient.create()
    }

    private val cryptoKeyName = CryptoKeyName.of(
        config.project, config.location,
        config.keyRing, config.cryptoKey
    )

    override fun wrapDek(dek: ByteArray): ByteArray {
        val result = kms.encrypt(cryptoKeyName, ByteString.copyFrom(dek))
        return result.ciphertext.toByteArray()
    }

    override fun unwrapDek(wrappedDek: ByteArray): ByteArray {
        return kms.decrypt(cryptoKeyName, ByteString.copyFrom(wrappedDek)).plaintext
            .toByteArray()
    }
}