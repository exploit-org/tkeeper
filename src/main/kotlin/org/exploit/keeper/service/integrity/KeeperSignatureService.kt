package org.exploit.keeper.service.integrity

import jakarta.inject.Singleton
import org.exploit.crypto.curve.Ed25519Provider
import org.exploit.keeper.db.RocksKeyDB
import org.exploit.keeper.extension.crypto.toSchnorrSignature
import org.exploit.tss.util.Hash
import java.util.*

@Singleton
class KeeperSignatureService(private val db: RocksKeyDB) {
    fun sign(bytes: ByteArray, version: Int? = null) : ByteArray {
        val integrityKeyPair = db.readIntegrityKeyPair(version)

        return try {
            Ed25519Provider.getInstance().sign(bytes, integrityKeyPair).encode()
        } finally {
            integrityKeyPair.erase()
        }
    }

    fun verify(data: ByteArray, signature: ByteArray, version: Int? = null): Boolean {
        val integrityPublicKey = db.readIntegrityPublicKey(version)

        return Ed25519Provider.getInstance()
            .verify(data, signature.toSchnorrSignature(), integrityPublicKey)
    }

    fun hashForSigning(
        instanceId: Int,
        intendedFor: Int,
        path: String,
        query: Map<String, String>,
        timestamp: Long,
        nonce: String,
        kid64: String,
        proof64: String
    ): ByteArray {
        val s = StringJoiner("\n")
        s.add(instanceId.toString())
        s.add(intendedFor.toString())
        s.add(path)

        if (query.isNotEmpty())
            query.toSortedMap().forEach { (k, v) ->
                s.add("$k=$v")
            }

        s.add(timestamp.toString())
        s.add(nonce)
        s.add(kid64)
        s.add(proof64)

        return Hash.sha256(s.toString().toByteArray())
    }

    companion object {
        const val HEADER_INSTANCE_ID = "X-INSTANCE-ID"
        const val HEADER_TIMESTAMP = "X-TIMESTAMP"
        const val HEADER_NONCE = "X-NONCE"
        const val HEADER_INTENDED_FOR = "X-INTENDED-FOR"
        const val HEADER_SIGNATURE = "X-SIGNATURE"
        const val HEADER_KID = "X-KEY-ID"
        const val HEADER_PUBLIC_KEY = "X-PUBLIC-KEY"
        const val HEADER_BOOT_PROOF = "X-BOOT-PROOF"
    }
}