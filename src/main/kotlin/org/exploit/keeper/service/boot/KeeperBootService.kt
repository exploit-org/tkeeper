package org.exploit.keeper.service.boot

import jakarta.inject.Singleton
import org.exploit.crypto.Hash
import org.exploit.keeper.config.boot.BootConfig
import org.exploit.keeper.db.RocksKeyDB
import org.exploit.keeper.extension.crypto.toBase64
import org.exploit.keeper.extension.toKeeperId
import org.exploit.keeper.model.boot.BootData
import org.exploit.keeper.service.audit.crypto.KeeperMacService
import java.util.*

@Singleton
class KeeperBootService(
    private val db: RocksKeyDB,
    private val config: BootConfig,
    private val mac: KeeperMacService
) {
    private val initData by lazy {
        db.readInitData()
    }

    fun prepare(intendedFor: Int, timestamp: Long, nonce: String): BootData {
        val publicKey = db.readIntegrityPublicKey()
            .encoded()

        val kid = Hash.sha256(publicKey)

        val payload = payload(
            instanceId = initData.peerId,
            kid = kid,
            timestamp = timestamp,
            nonce = nonce,
            intendedFor = intendedFor
        )

        val proof = mac(payload)

        return BootData(
            kid64 = kid.toBase64(),
            publicKey64 = publicKey.toBase64(),
            bootProof64 = proof.toBase64()
        )
    }

    fun verify(instanceId: Int, pub: ByteArray, proof: ByteArray, timestamp: Long, nonce: String): Boolean {
        val kid = Hash.sha256(pub)

        val payload = payload(
            instanceId = instanceId,
            kid = kid,
            timestamp = timestamp,
            nonce = nonce,
            intendedFor = initData.peerId
        )

        return config.token.read {
            mac.verify(proof, it, payload, PURPOSE, 0)
        }
    }

    private fun payload(instanceId: Int, kid: ByteArray, timestamp: Long, nonce: String, intendedFor: Int): ByteArray {
        val payloadBuilder = StringJoiner("\n")

        payloadBuilder.add(instanceId.toKeeperId())
        payloadBuilder.add(timestamp.toString())
        payloadBuilder.add(nonce)
        payloadBuilder.add(kid.toBase64())
        payloadBuilder.add(intendedFor.toKeeperId())

        return payloadBuilder.toString().toByteArray()
    }

    private fun mac(payload: ByteArray): ByteArray {
        return config.token.read {
            mac.mac(it, PURPOSE, payload, version = 0)
        }
    }

    private companion object {
        const val PURPOSE = "BOOT"
    }
}