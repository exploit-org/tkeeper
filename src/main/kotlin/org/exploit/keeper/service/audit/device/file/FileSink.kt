package org.exploit.keeper.service.audit.device.file

import java.io.Closeable
import java.nio.ByteBuffer
import java.nio.channels.FileChannel
import java.nio.file.Path
import java.nio.file.StandardOpenOption

class FileSink(path: Path) : Closeable {
    private val ch: FileChannel = FileChannel.open(path,
        StandardOpenOption.CREATE,
        StandardOpenOption.WRITE,
        StandardOpenOption.APPEND
    )

    fun write(bytes: ByteArray, fsync: Boolean) {
        val buf = ByteBuffer.wrap(bytes)

        while (buf.hasRemaining()) {
            ch.write(buf)
        }

        if (fsync)
            ch.force(true)
    }

    override fun close() {
        ch.force(true)
        ch.close()
    }
}
