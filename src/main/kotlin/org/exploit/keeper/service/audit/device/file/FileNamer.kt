package org.exploit.keeper.service.audit.device.file

import java.nio.file.Path
import java.time.Instant
import java.time.ZoneOffset
import java.time.format.DateTimeFormatter

class FileNamer(
    private val dir: Path,
    private val prefix: String,
    private val ext: String
) {
    private val fmt = DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss").withZone(ZoneOffset.UTC)
    private var counter: Int = 0

    fun current(): Path = dir.resolve("$prefix-current.$ext")

    fun rolled(now: Instant): Path {
        counter = (counter + 1) and 0xFFFF
        val name = "$prefix-${fmt.format(now)}-$counter.$ext"

        return dir.resolve(name)
    }

    fun isCandidate(p: Path): Boolean {
        val n = p.fileName.toString()

        return n.startsWith(prefix) &&
                n != "$prefix-current.$ext" &&
                (n.endsWith(".$ext") || n.endsWith(".$ext.gz"))
    }
}