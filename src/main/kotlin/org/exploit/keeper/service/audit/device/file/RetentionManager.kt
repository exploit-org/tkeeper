package org.exploit.keeper.service.audit.device.file

import java.nio.file.Files
import java.nio.file.Path
import java.time.Duration
import java.time.Instant

class RetentionManager(
    private val dir: Path,
    private val namer: FileNamer,
    private val maxFiles: Int,
    private val retentionDays: Int?
) {
    fun apply(now: Instant) {
        val files = Files.list(dir).use { st ->
            st.filter { namer.isCandidate(it) }.sorted { a, b ->
                Files.getLastModifiedTime(a).toMillis().compareTo(Files.getLastModifiedTime(b).toMillis())
            }.toList()
        }

        if (maxFiles >= 0 && files.size > maxFiles) {
            files.take(files.size - maxFiles).forEach { safeDelete(it) }
        }

        if (retentionDays != null) {
            val threshold = now.minus(Duration.ofDays(retentionDays.toLong()))
            files.forEach {
                val lm = Files.getLastModifiedTime(it).toInstant()
                if (lm.isBefore(threshold)) safeDelete(it)
            }
        }
    }

    private fun safeDelete(p: Path) {
        try { Files.deleteIfExists(p) } catch (_: Exception) {}
    }
}