package org.exploit.keeper.service.signature.gg20.initiator

import org.exploit.keeper.api.client.TKeeperClient
import org.exploit.keeper.extension.performAndReturnDead
import org.exploit.keeper.model.common.Round
import org.exploit.keeper.service.signature.gg20.GG20CommitmentHandler
import org.exploit.tss.curve.ec.WeierstrassPointOps

class GG20CommitmentBroadcaster<P : WeierstrassPointOps<P>>(private val handler: GG20CommitmentHandler<P>) {
    fun broadcast(clients: List<TKeeperClient>, sessionId: String): Round<Void> {
        val r = handler.broadcastGammaCommitment(sessionId)

        if (r.restart)
            return r

        val (responses, dead) = clients.performAndReturnDead { it.gg20.broadcastCommitment(sessionId) }

        if (dead.isNotEmpty())
            return Round(null, dead = dead, restart = true)

        val imposters = HashSet<Int>()
        val deadR = HashSet<Int>()

        responses.forEach {
            imposters.addAll(it.value.body().imposters)
            deadR.addAll(it.value.body.dead)
        }

        return Round(null, dead = deadR, imposters = imposters, restart = dead.isNotEmpty() || imposters.isNotEmpty())
    }
}