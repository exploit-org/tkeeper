package org.exploit.keeper.service.signature.gg20.initiator

import io.sentry.Sentry
import io.smallrye.mutiny.Uni
import org.exploit.keeper.constant.KeeperCurve
import org.exploit.keeper.constant.SessionType
import org.exploit.keeper.extension.toUni
import org.exploit.keeper.model.Operations
import org.exploit.keeper.model.TSSResult
import org.exploit.keeper.model.event.SessionCleanEvent
import org.exploit.keeper.service.client.BitKeeperClients
import org.exploit.keeper.service.signature.SignatureService
import org.exploit.keeper.util.ErrorHandlers
import org.exploit.signalix.manager.EventScope
import org.exploit.tss.curve.ec.WeierstrassPointOps
import reactor.core.publisher.Mono.defer
import reactor.core.publisher.Mono.just

class GG20SignatureService<P : WeierstrassPointOps<P>>(
    private val clients: BitKeeperClients,
    private val peerInitializer: GG20PeerInitializer<P>,
    private val commitmentBroadcaster: GG20CommitmentBroadcaster<P>,
    private val mtaInitiator: GG20MtAInitiator<P>,
    private val offlinePhaseCollector: GG20OfflinePhaseCollector<P>,
    private val finalizer: GG20SignatureFinalizer<P>,
    private val eventScope: EventScope
): SignatureService<P> {
    override fun sign(sessionId: String, keyId: String, operations: Operations, curve: KeeperCurve<P>): Uni<TSSResult> {
        return clients.findThreshold()
            .flatMap { peerInitializer.init(it, sessionId, keyId, operations, curve) }
            .flatMap { commitmentBroadcaster.broadcast(it, sessionId) }
            .flatMap { mtaInitiator.startMtA(it, sessionId) }
            .flatMap { offlinePhaseCollector.collect(it, sessionId) }
            .flatMap { defer { finalizer.completeSignature(it, sessionId).map { TSSResult.success(it) } } }
            .doOnNext { eventScope.call(SessionCleanEvent(sessionId, SessionType.GG20)) }
            .doOnError {
                Sentry.captureException(it)
                ErrorHandlers.handleAbort(sessionId, SessionType.GG20, eventScope, it)
            }
            .onErrorResume {
                just(TSSResult.failed())
            }
            .toUni()
    }
}