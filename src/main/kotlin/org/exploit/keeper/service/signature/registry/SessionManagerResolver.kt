package org.exploit.keeper.service.signature.registry

import jakarta.inject.Singleton
import org.exploit.keeper.constant.crypto.CurveName
import org.exploit.keeper.constant.crypto.SessionType
import org.exploit.keeper.db.RocksKeyDB
import org.exploit.keeper.extension.extractCurveAndDestroy

@Singleton
class SessionManagerResolver(
    private val db: RocksKeyDB,
    private val instances: List<SessionManagerInstance>
) {
    fun findManager(type: SessionType, curve: CurveName): SessionManagerInstance? {
        return instances.find { it.session() == type && it.curve() == curve }
    }

    fun findBySessionId(type: SessionType, sessionId: String) : SessionManagerInstance? {
        return instances.find { it.session() == type && it.hasSessionId(sessionId) }
    }

    fun findByKeyId(type: SessionType, keyId: String): SessionManagerInstance? {
        val curve = db.vault.readCurrentKey(keyId)
            ?.extractCurveAndDestroy()
            ?: return null

        return findManager(type, curve)
    }
}