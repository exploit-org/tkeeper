package org.exploit.keeper.server

import com.linecorp.armeria.common.TlsKeyPair
import com.linecorp.armeria.common.TlsProvider
import com.linecorp.armeria.server.ServerBuilder
import jakarta.annotation.PreDestroy
import jakarta.inject.Singleton
import org.exploit.keeper.config.keeper.KeeperServerConfig
import java.io.FileInputStream
import java.nio.file.Files
import java.nio.file.Path
import java.security.KeyStore
import java.util.concurrent.Executors
import javax.net.ssl.KeyManagerFactory

@Singleton
class ServerTLSConfigurer : AutoCloseable {
    private val exec = Executors.newSingleThreadScheduledExecutor { r ->
        Thread(r, "tls-reloader").apply { isDaemon = true }
    }

    private val providers = mutableListOf<TlsProvider>()

    fun applyPem(sb: ServerBuilder, tls: KeeperServerConfig.Tls) {
        val cert = Path.of(requireNotNull(tls.certificateChainPath))
        val key  = Path.of(requireNotNull(tls.privateKeyPath))
        require(Files.isRegularFile(cert)) { "Missing cert: $cert" }
        require(Files.isRegularFile(key))  { "Missing key: $key" }

        val refreshEvery = tls.refreshEvery

        val p = if (refreshEvery == null) {
            TlsProvider.of(TlsKeyPair.of(key.toFile(), tls.privateKeyPassword, cert.toFile()))
        } else {
            TlsProvider.ofScheduled(
                { TlsKeyPair.of(key.toFile(), tls.privateKeyPassword, cert.toFile()) },
                refreshEvery,
                exec
            )
        }

        providers += p
        sb.tlsProvider(p)
    }

    fun applyKsTLS(sb: ServerBuilder, tls: KeeperServerConfig.Tls) {
        val ksPath = requireNotNull(tls.keyStorePath)
        val pwd = (tls.keyStorePassword ?: "").toCharArray()

        val ksType = tls.keyStoreType
            ?: when {
                ksPath.endsWith(".p12", ignoreCase = true) || ksPath.endsWith(".pfx", ignoreCase = true) -> "PKCS12"
                else -> "JKS"
            }

        val ks = KeyStore.getInstance(ksType)
        FileInputStream(ksPath).use { ks.load(it, pwd) }

        val kmf = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm())
        kmf.init(ks, pwd)

        sb.tls(kmf)
    }

    @PreDestroy
    override fun close() {
        providers.forEach { runCatching { it.close() } }
        providers.clear()

        exec.shutdownNow()
    }
}