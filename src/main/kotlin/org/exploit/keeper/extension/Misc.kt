package org.exploit.keeper.extension

import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.crypto.CurveName
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.util.KeySerializer
import java.nio.ByteBuffer
import java.util.function.Function

fun ByteArray.toPrivateKey() = KeySerializer.deserialize(this)

fun ByteArray.extractCurveAndDestroy(): CurveName = this.toPrivateKey().let { p ->
    p.curve.also { p.destroy() }
}

fun Int.toByteArray(): ByteArray = ByteBuffer.allocate(4)
    .putInt(this).array()

fun ByteArray.toInt(): Int = ByteBuffer.wrap(this).int

fun Int.toKeeperId(): String = "keeper-$this"

inline fun ensure(condition: Boolean, lazyMessage: () -> ErrorType) {
    if (!condition) {
        throw TKeeperException(lazyMessage())
    }
}

fun <T> ByteArray.use(function: Function<ByteArray, T>): T {
    try {
        return function.apply(this)
    } finally {
        this.fill(0)
    }
}