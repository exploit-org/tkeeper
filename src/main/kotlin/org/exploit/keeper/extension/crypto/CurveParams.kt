package org.exploit.keeper.extension.crypto

import org.exploit.ed25519.Ed25519CurveParams
import org.exploit.tss.curve.EllipticCurveParams
import org.exploit.tss.curve.PointOps

fun <P : PointOps<P>> EllipticCurveParams<P>.decodePointSafeIdentity(bytes: ByteArray): PointOps<P> {
    if (this is Ed25519CurveParams && isEd25519IdentityCompressed(bytes)) {
        return infinity
    }

    return decodePoint(bytes)
}

private fun isEd25519IdentityCompressed(b: ByteArray): Boolean {
    if (b.size != 32) return false
    if (b[0] != 1.toByte()) return false
    for (i in 1 until 32) if (b[i] != 0.toByte()) return false
    return true
}