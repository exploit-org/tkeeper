package org.exploit.keeper.extension.http

import com.linecorp.armeria.server.ServiceRequestContext
import io.netty.util.AttributeKey
import org.exploit.keeper.model.auth.AuthData
import java.net.URLDecoder
import java.nio.charset.StandardCharsets

val AUDIT_ATTRIBUTE_KEY: AttributeKey<String> = AttributeKey.valueOf("REQUEST_ID")
val AUTH_ATTRIBUTE_KEY: AttributeKey<AuthData> = AttributeKey.valueOf("AUTH_DATA")

fun ServiceRequestContext.auditId(): String? =
    this.attr(AUDIT_ATTRIBUTE_KEY)

fun ServiceRequestContext.authData(): AuthData? =
    this.attr(AUTH_ATTRIBUTE_KEY)

fun ServiceRequestContext.hasPermission(permission: String): Boolean {
    val auth = this.authData() ?: return false
    return auth.hasPermission(permission)
}

fun String.toQueryMap(): Map<String, String> {
    if (this.isBlank()) return emptyMap()
    return this.trimStart('?')
        .split("&", ";")
        .filter { it.isNotEmpty() }
        .associate { part ->
            val i = part.indexOf('=')
            val rawKey = if (i >= 0) part.substring(0, i) else part
            val rawVal = if (i >= 0) part.substring(i + 1) else ""
            val key = URLDecoder.decode(rawKey, StandardCharsets.UTF_8)
            val value = URLDecoder.decode(rawVal, StandardCharsets.UTF_8)
            key to value
        }
        .toSortedMap()
}