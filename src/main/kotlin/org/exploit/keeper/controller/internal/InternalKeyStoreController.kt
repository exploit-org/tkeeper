package org.exploit.keeper.controller.internal

import com.linecorp.armeria.common.QueryParams
import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.model.keygen.StoreRaw
import org.exploit.keeper.service.core.KeeperStorageService

@Singleton
class InternalKeyStoreController(
    private val support: ControllerSupport,
    private val storage: KeeperStorageService
) : InternalController {
    override fun register(sb: ServerBuilder) = with(support) {
        sb.internalPost("/v1/storage/store", StoreRaw::class.java) { _, body ->
            storage.storeShare(body)
        }

        sb.internalPost("/v1/storage/revert") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId")
                ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)

            storage.deleteShare(keyId)
        }
    }
}