package org.exploit.keeper.controller.internal

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.model.RawPublicKeyDto
import org.exploit.keeper.service.pub.PublicKeyShareCalculator

@Singleton
class InternalPublicKeyController(
    private val support: ControllerSupport,
    private val pubShare: PublicKeyShareCalculator
) : InternalController {
    override fun register(sb: ServerBuilder) = with(support) {
        sb.internalGet("/v1/publicKey/{keyId}") { ctx ->
            val keyId = ctx.pathParam("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)
            val raw = pubShare.pubKeyShare(keyId).share.encode(true)
            RawPublicKeyDto(raw)
        }
    }
}