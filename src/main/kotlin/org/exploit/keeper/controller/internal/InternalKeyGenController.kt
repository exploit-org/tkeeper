package org.exploit.keeper.controller.internal

import com.linecorp.armeria.common.QueryParams
import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.crypto.KeeperCurve
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.model.keygen.InitKeyGen
import org.exploit.keeper.service.dkg.DistributedKeyCollector
import org.exploit.keeper.service.dkg.DistributedKeyGen
import org.exploit.keeper.service.integrity.KeeperSignatureService

@Singleton
class InternalKeyGenController(
    private val support: ControllerSupport,
    private val generator: DistributedKeyGen,
    private val collector: DistributedKeyCollector
) : InternalController {

    override fun register(sb: ServerBuilder) = with(support) {
        sb.internalPost("/v1/keygen/init", InitKeyGen::class.java) { ctx, body ->
            val curve = KeeperCurve.fromName(body.curve)
            generator.init(body.keyId, curve, body.mode, body.policy, body.targetGeneration)
        }

        sb.internalPost("/v1/keygen/collect") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)
            collector.collect(keyId)
        }

        sb.internalPost("/v1/keygen/compute") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)
            generator.compute(keyId)
        }

        sb.internalPost("/v1/keygen/abort") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)

            val gen = q.get("generation")?.toIntOrNull()
            if (gen != null) generator.abort(keyId, gen) else generator.abort(keyId)
        }

        sb.internalPost("/v1/keygen/session/abort") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)
            generator.abortSession(keyId)
        }

        sb.internalPost("/v1/keygen/dropPending") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)

            val gen = q.get("generation")?.toIntOrNull()
                ?: throw TKeeperException(ErrorType.INVALID_KEY_GENERATION, "Missing or invalid 'generation'")

            generator.dropPending(keyId, gen)
        }

        sb.internalPost("/v1/keygen/sync") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)

            val gen = q.get("generation")?.toIntOrNull()
                ?: throw TKeeperException(ErrorType.INVALID_KEY_GENERATION, "Missing or invalid 'generation'")

            generator.sync(keyId, gen)
        }

        sb.internalGet("/v1/keygen/share") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)

            val idx = ctx.request().headers()
                .get(KeeperSignatureService.HEADER_INSTANCE_ID)
                ?.toIntOrNull()
                ?: throw TKeeperException(ErrorType.ACCESS_DENIED, "No instance id header found")

            generator.share(idx, keyId)
        }

        sb.internalGet("/v1/keygen/version") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)
            generator.versions(keyId)
        }

        sb.internalPost("/v1/keygen/complete") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)
            generator.complete(keyId)
        }
    }
}