package org.exploit.keeper.controller.internal

import com.linecorp.armeria.common.QueryParams
import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.crypto.CurveName
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.crypto.KeeperCurve
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.service.dkg.DistributedKeyCollector
import org.exploit.keeper.service.dkg.DistributedKeyGen
import org.exploit.keeper.service.integrity.KeeperSignatureService

@Singleton
class InternalKeyGenController(
    private val support: ControllerSupport,
    private val generator: DistributedKeyGen,
    private val collector: DistributedKeyCollector
) : InternalController {

    override fun register(sb: ServerBuilder) = with(support) {
        sb.internalPost("/v1/keygen/init") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)
            val curveName = q.get("curve")?.let { CurveName.fromName(it) }
                ?: throw TKeeperException(ErrorType.UNSUPPORTED_CURVE)

            val curve = KeeperCurve.fromName(curveName)
            val overwrite = q.get("overwrite")?.toBoolean() ?: false
            val refresh = q.get("refresh")?.toBoolean() ?: false

            generator.init(keyId, curve, overwrite, refresh)
        }

        sb.internalPost("/v1/keygen/collect") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)

            collector.collect(keyId)
        }

        sb.internalPost("/v1/keygen/compute") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)
            generator.compute(keyId)
        }

        sb.internalPost("/v1/keygen/abort") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)
            generator.abort(keyId)
        }

        sb.internalGet("/v1/keygen/share") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)
            val idx = ctx.request().headers().get(KeeperSignatureService.HEADER_INSTANCE_ID)?.toIntOrNull()
                ?: throw TKeeperException(ErrorType.ACCESS_DENIED, "No instance id header found")

            generator.share(idx, keyId)
        }
    }
}
