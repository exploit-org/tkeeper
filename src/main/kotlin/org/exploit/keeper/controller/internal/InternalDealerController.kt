package org.exploit.keeper.controller.internal

import com.linecorp.armeria.common.QueryParams
import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.model.keygen.import.ImportShare
import org.exploit.keeper.service.core.KeeperDealerService

@Singleton
class InternalDealerController(
    private val dealer: KeeperDealerService,
    private val support: ControllerSupport
) : InternalController {

    override fun register(sb: ServerBuilder) = with(support) {
        sb.internalPost("/v1/dealer/import", ImportShare::class.java) { ctx, body ->
            dealer.import(body)
        }

        sb.internalPost("/v1/dealer/revert") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)

            dealer.revertShare(keyId)
        }

        sb.internalPost("/v1/dealer/sync") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val keyId = q.get("keyId") ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)

            dealer.sync(keyId)
        }
    }
}