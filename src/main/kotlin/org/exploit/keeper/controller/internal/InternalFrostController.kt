package org.exploit.keeper.controller.internal

import com.linecorp.armeria.common.QueryParams
import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.crypto.CurveName
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.crypto.SessionType
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.model.common.InitSession
import org.exploit.keeper.model.frost.FrostOperationCommitment
import org.exploit.keeper.service.integrity.KeeperSignatureService
import org.exploit.keeper.service.signature.frost.FrostSessionManager
import org.exploit.keeper.service.signature.registry.SessionManagerResolver

@Singleton
class InternalFrostController(
    private val support: ControllerSupport,
    private val resolver: SessionManagerResolver
) : InternalController {

    override fun register(sb: ServerBuilder) = with(support) {
        sb.internalPost("/v1/frost/init", InitSession::class.java) { _, body ->
            manager(body.curve).createSession(
                sessionId = body.sessionId,
                keyId = body.keyId,
                operations = body.operations,
                publicKey = body.publicKey,
                participants = body.participants,
                context = body.context
            )

            Unit
        }

        sb.internalPost("/v1/frost/commitment", FrostOperationCommitment::class.java) { ctx, body ->
            val q = QueryParams.fromQueryString(ctx.query())
            val sessionId = q.get("sessionId") ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)
            val peerId = ctx.request().headers().get(KeeperSignatureService.HEADER_INSTANCE_ID)?.toIntOrNull()
                ?: throw TKeeperException(ErrorType.ACCESS_DENIED, "Not instance id header found")

            manager(sessionId).respondent.commitment.store(sessionId, peerId, body)
        }

        sb.internalPost("/v1/frost/commitment/broadcast") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val sessionId = q.get("sessionId") ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)

            manager(sessionId).respondent
                .commitment.broadcast(sessionId)

        }

        sb.internalGet("/v1/frost/signature/z") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val sessionId = q.get("sessionId") ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)

            manager(sessionId).respondent.sigPart.computeZ(sessionId)
        }

        sb.internalGet("/v1/frost/abort") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val sessionId = q.get("sessionId") ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)

            manager(sessionId).clear(sessionId)
        }
    }

    private fun manager(curve: CurveName): FrostSessionManager<*> =
        resolver.findManager(SessionType.FROST, curve) as? FrostSessionManager<*>
            ?: throw TKeeperException(ErrorType.UNSUPPORTED_CURVE, curve.name)

    private fun manager(sessionId: String): FrostSessionManager<*> =
        resolver.findBySessionId(SessionType.FROST, sessionId) as? FrostSessionManager<*>
            ?: throw TKeeperException(ErrorType.INVALID_SESSION_ID)
}