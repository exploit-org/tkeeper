package org.exploit.keeper.controller.internal

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.model.destroy.KeyDestroyIntent
import org.exploit.keeper.service.destroy.KeeperDestroyPeerHandler

@Singleton
class InternalDestroyController(
    private val support: ControllerSupport,
    private val handler: KeeperDestroyPeerHandler
): InternalController {
    override fun register(sb: ServerBuilder) {
        with(support) {
            sb.internalPost("/v1/destroy/prepare", KeyDestroyIntent::class.java) { _, body ->
                handler.prepare(body)
            }

            sb.internalPost("/v1/destroy/commit") { ctx ->
                val sid = ctx.queryParam("sessionId")
                    ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)

                handler.commit(sid)
            }

            sb.internalPost("/v1/destroy/abort") { ctx ->
                val sid = ctx.queryParam("sessionId")
                    ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)

                handler.abort(sid)
            }
        }
    }
}