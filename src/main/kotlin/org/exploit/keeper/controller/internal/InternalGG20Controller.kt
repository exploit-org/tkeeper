package org.exploit.keeper.controller.internal

import com.linecorp.armeria.common.QueryParams
import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.crypto.CurveName
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.crypto.SessionType
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.model.common.InitSession
import org.exploit.keeper.model.gg20.commitment.GG20GammaCommitmentDto
import org.exploit.keeper.model.gg20.commitment.GG20OfflinePhaseData
import org.exploit.keeper.model.gg20.mta.GG20MtAComputeRequest
import org.exploit.keeper.service.integrity.KeeperSignatureService
import org.exploit.keeper.service.signature.gg20.GG20SessionManager
import org.exploit.keeper.service.signature.registry.SessionManagerResolver

@Singleton
class InternalGG20Controller(
    private val support: ControllerSupport,
    private val resolver: SessionManagerResolver
) : InternalController {

    override fun register(sb: ServerBuilder) = with(support) {
        sb.internalPost("/v1/gg20/init", InitSession::class.java) { _, body ->
            manager(body.curve).createSession(
                sessionId = body.sessionId,
                keyId = body.keyId,
                operations = body.operations,
                participants = body.participants,
                publicKey = body.publicKey,
                additionalContext = body.additionalContext
            )
            Unit
        }

        sb.internalPost("/v1/gg20/commitment", GG20GammaCommitmentDto::class.java) { ctx, body ->
            val q = QueryParams.fromQueryString(ctx.query())
            val sessionId = q.get("sessionId") ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)
            val peerId = ctx.request().headers().get(KeeperSignatureService.HEADER_INSTANCE_ID)?.toIntOrNull()
                ?: throw TKeeperException(ErrorType.ACCESS_DENIED, "No instance id header found")

            manager(sessionId).respondent.commitment.storeCommitment(sessionId, peerId, body)
        }

        sb.internalPost("/v1/gg20/commitment/broadcast") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val sessionId = q.get("sessionId") ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)

            manager(sessionId).respondent.commitment.broadcastGammaCommitment(sessionId)
        }

        sb.internalPost("/v1/gg20/mta/exchange") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val sessionId = q.get("sessionId") ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)

            manager(sessionId).respondent.mta.exchange(sessionId)
        }

        sb.internalPost("/v1/gg20/mta/compute", GG20MtAComputeRequest::class.java) { ctx, body ->
            val idx = ctx.request().headers().get(KeeperSignatureService.HEADER_INSTANCE_ID)?.toIntOrNull()
                ?: throw TKeeperException(ErrorType.ACCESS_DENIED, "No instance id header found")

            manager(body.sessionId).respondent.mta.compute(idx, body)
        }

        sb.internalPost("/v1/gg20/prephase", GG20OfflinePhaseData::class.java) { ctx, body ->
            val q = QueryParams.fromQueryString(ctx.query())
            val sessionId = q.get("sessionId") ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)
            val idx = ctx.request().headers().get(KeeperSignatureService.HEADER_INSTANCE_ID)?.toIntOrNull()
                ?: throw TKeeperException(ErrorType.ACCESS_DENIED, "No instance id header found")

            manager(sessionId).respondent.offlinePhase.store(sessionId, idx, body)
        }

        sb.internalPost("/v1/gg20/prephase/broadcast") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val sessionId = q.get("sessionId") ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)

            manager(sessionId).respondent.offlinePhase.broadcast(sessionId)
        }

        sb.internalGet("/v1/gg20/signature/s") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val sessionId = q.get("sessionId") ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)

            manager(sessionId).respondent.sigPart.computePartialS(sessionId, finalize = true)
        }

        sb.internalPost("/v1/gg20/abort") { ctx ->
            val q = QueryParams.fromQueryString(ctx.query())
            val sessionId = q.get("sessionId") ?: throw TKeeperException(ErrorType.MISSING_SESSION_ID)

            manager(sessionId).clear(sessionId)
        }
    }

    private fun manager(curve: CurveName): GG20SessionManager<*> =
        resolver.findManager(SessionType.GG20, curve) as? GG20SessionManager<*>
            ?: throw TKeeperException(ErrorType.SESSION_MANAGER_NOT_FOUND)

    private fun manager(sessionId: String): GG20SessionManager<*> =
        resolver.findBySessionId(SessionType.GG20, sessionId) as? GG20SessionManager<*>
            ?: throw TKeeperException(ErrorType.SESSION_MANAGER_NOT_FOUND)
}
