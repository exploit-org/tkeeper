package org.exploit.keeper.controller.keygen

import io.smallrye.mutiny.Uni
import jakarta.ws.rs.POST
import jakarta.ws.rs.Path
import jakarta.ws.rs.container.ContainerRequestContext
import org.exploit.keeper.constant.KeeperCurve
import org.exploit.keeper.constant.Permission
import org.exploit.keeper.model.request.Generate
import org.exploit.keeper.service.auth.policy.MachinePolicyChecker
import org.exploit.keeper.service.keygen.starter.DKGenerator

@Path("/v1/keeper/dkg")
class KeyGenController(
    private val dkg: DKGenerator,
    private val policyChecker: MachinePolicyChecker,
    private val ctx: ContainerRequestContext
) {
    @POST
    @Path("/generate")
    fun generate(body: Generate): Uni<Void> {
        policyChecker.ensureHasPermission(ctx, Permission.generateKey())

        return dkg.generateKey(
            keyId = body.keyId,
            curve = KeeperCurve.fromName(body.curve),
            overwrite = body.overwrite
        )
    }
}