package org.exploit.keeper.controller.external

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.permission.Permission
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.http.hasPermission
import org.exploit.keeper.model.key.KeyReference
import org.exploit.keeper.service.destroy.KeeperDestroyService

@Singleton
class DestroyController(
    private val support: ControllerSupport,
    private val destroyer: KeeperDestroyService
): ExternalController {
    override fun register(sb: ServerBuilder) {
        with(support) {
            sb.publicPost("/v1/keeper/destroy", KeyReference::class.java) { ctx, body ->
                if (!ctx.hasPermission(Permission.keyDestroy(body.keyId)))
                    throw TKeeperException(ErrorType.ACCESS_DENIED)

                destroyer.destroy(body.keyId, body.version)
            }
        }
    }
}