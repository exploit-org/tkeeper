package org.exploit.keeper.controller.external

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.permission.Permission
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.http.hasPermission
import org.exploit.keeper.model.VerifyResult
import org.exploit.keeper.model.request.Sign
import org.exploit.keeper.model.request.Verify
import org.exploit.keeper.service.core.KeeperService
import org.exploit.keeper.service.signature.registry.SessionManagerResolver
import org.exploit.keeper.service.signature.verify.SignatureVerifyManager
import org.exploit.keeper.util.validation.InputValidator

@Singleton
class SignatureController(
    private val support: ControllerSupport,
    private val resolver: SessionManagerResolver,
    private val keeper: KeeperService,
    private val verifyManager: SignatureVerifyManager
) : ExternalController {

    override fun register(sb: ServerBuilder) = with(support) {
        sb.publicPost("/v1/keeper/sign", Sign::class.java) { ctx, body ->
            if (!ctx.hasPermission(Permission.keySign(body.keyId)))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            keeper.ensureReady()

            if (!InputValidator.isValidKeyId(body.keyId))
                throw TKeeperException(ErrorType.INVALID_KEY_ID)

            val manager = resolver.findByKeyId(body.algorithm, body.keyId)
                ?: throw TKeeperException(ErrorType.SESSION_MANAGER_NOT_FOUND)

            manager.sign(body)
        }

        sb.publicPost("/v1/keeper/sign/verify", Verify::class.java) { ctx, body ->
            if (!ctx.hasPermission(Permission.keyVerify(body.keyId)))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            keeper.ensureReady()

            if (!InputValidator.isValidKeyId(body.keyId))
                throw TKeeperException(ErrorType.INVALID_KEY_ID)

            val ok = verifyManager.verify(body)
            VerifyResult(ok)
        }
    }
}