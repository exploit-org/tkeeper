package org.exploit.keeper.controller.external

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.expire.ExpireType
import org.exploit.keeper.constant.permission.Permission
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.http.hasPermission
import org.exploit.keeper.service.expire.KeeperExpireService
import java.time.Instant

@Singleton
class ExpireController(
    private val expire: KeeperExpireService,
    private val support: ControllerSupport
) : ExternalController {
    override fun register(sb: ServerBuilder) = with(support) {
        sb.publicGet("/v1/keeper/expires") { ctx ->
            if (!ctx.hasPermission(Permission.expiredView()))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            val typeStr = ctx.queryParam("type") ?: throw TKeeperException(ErrorType.MISSING_EXPIRE_TYPE)
            val type = parseExpireType(typeStr)

            val limit = (ctx.queryParam("limit")?.toIntOrNull() ?: 100).coerceIn(1, 2000)
            val cursor = ctx.queryParam("cursor")

            val now = Instant.now().epochSecond

            val windowSec = ctx.queryParam("windowSec")?.toLongOrNull()
            val from = ctx.queryParam("from")?.toLongOrNull()
            val to = ctx.queryParam("to")?.toLongOrNull()

            return@publicGet when {
                windowSec != null -> expire.listExpiringWindow(
                    type = type,
                    windowSec = windowSec,
                    limit = limit,
                    cursor = cursor,
                    nowEpochSec = now
                )

                to != null -> expire.listExpiring(
                    type = type,
                    fromEpochSec = from ?: 0,
                    toEpochSec = to,
                    limit = limit,
                    cursor = cursor
                )

                else -> throw TKeeperException(ErrorType.MISSING_WINDOW)
            }
        }

        sb.publicGet("/v1/keeper/expires/apply") { ctx ->
            if (!ctx.hasPermission(Permission.expiredView()))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            val limit = (ctx.queryParam("limit")?.toIntOrNull() ?: 100).coerceIn(1, 2000)
            val cursor = ctx.queryParam("cursor")
            val now = Instant.now().epochSecond

            val windowSec = ctx.queryParam("windowSec")?.toLongOrNull()
                ?: throw TKeeperException(ErrorType.MISSING_WINDOW)

            expire.listApplyExpiringWindow(
                windowSec = windowSec,
                limit = limit,
                cursor = cursor,
                nowEpochSec = now
            )
        }

        sb.publicGet("/v1/keeper/expires/process") { ctx ->
            if (!ctx.hasPermission(Permission.expiredView()))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            val limit = (ctx.queryParam("limit")?.toIntOrNull() ?: 100).coerceIn(1, 2000)
            val cursor = ctx.queryParam("cursor")
            val now = Instant.now().epochSecond

            val windowSec = ctx.queryParam("windowSec")?.toLongOrNull()
                ?: throw TKeeperException(ErrorType.MISSING_WINDOW)

            expire.listProcessExpiringWindow(
                windowSec = windowSec,
                limit = limit,
                cursor = cursor,
                nowEpochSec = now
            )
        }

        sb.publicGet("/v1/keeper/expires/expired") { ctx ->
            if (!ctx.hasPermission(Permission.expiredView()))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            val typeStr = ctx.queryParam("type") ?: throw TKeeperException(ErrorType.MISSING_EXPIRE_TYPE)
            val type = parseExpireType(typeStr)

            val limit = (ctx.queryParam("limit")?.toIntOrNull() ?: 100).coerceIn(1, 2000)
            val cursor = ctx.queryParam("cursor")
            val now = Instant.now().epochSecond

            expire.listExpired(
                type = type,
                limit = limit,
                cursor = cursor,
                nowEpochSec = now
            )
        }
    }

    private fun parseExpireType(raw: String): ExpireType =
        when (raw.lowercase()) {
            "apply" -> ExpireType.APPLY
            "process" -> ExpireType.PROCESS
            else -> throw TKeeperException(ErrorType.INVALID_EXPIRE_TYPE)
        }
}