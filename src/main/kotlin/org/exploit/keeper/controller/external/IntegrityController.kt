package org.exploit.keeper.controller.external

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.permission.Permission
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.extension.http.hasPermission
import org.exploit.keeper.service.core.KeeperRequestIntegrityService

@Singleton
class IntegrityController(
    private val support: ControllerSupport,
    private val integrity: KeeperRequestIntegrityService
) : ExternalController {
    override fun register(sb: ServerBuilder): Unit = with(support) {
        sb.publicPost("/v1/keeper/integrity/rotate") { ctx ->
            if (!ctx.hasPermission(Permission.integrityRotate())) {
                return@publicPost finishErrorJson(ctx, ErrorType.ACCESS_DENIED)
            }

            integrity.regenerateIntegrityKey()
            finishNoContent(ctx)
        }
    }
}