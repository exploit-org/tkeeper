package org.exploit.keeper.controller.external

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.common.StoreState
import org.exploit.keeper.constant.permission.Permission
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.http.hasPermission
import org.exploit.keeper.model.request.KeeperInitData
import org.exploit.keeper.model.request.Unseal
import org.exploit.keeper.service.core.KeeperService

@Singleton
class SystemController(
    private val keeper: KeeperService,
    private val support: ControllerSupport
) : ExternalController {

    override fun register(sb: ServerBuilder) = with(support) {
        sb.publicGet("/v1/keeper/system/status") { ctx ->
            keeper.status().let {
                if (!ctx.hasPermission(Permission.systemUnseal()))
                    it.copy(sealedBy = null)
                else
                    it
            }
        }

        sb.publicPost("/v1/keeper/system/init", KeeperInitData::class.java) { ctx, body ->
            if (!ctx.hasPermission(Permission.systemInit()))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            body.validate()
            val initData = keeper.initialize(body)

            if (initData.hasData()) {
                return@publicPost initData
            }

            finishNoContent(ctx)
        }

        sb.publicGet("/v1/keeper/system/health") { ctx ->
            finishNoContent(ctx)
        }

        sb.publicGet("/v1/keeper/system/ready") { ctx ->
            val state = keeper.status().state
            if (state == StoreState.UNSEALED) {
                finishNoContent(ctx)
            } else {
                finishUnavailable(ctx)
            }
        }

        sb.publicPost("/v1/keeper/system/unseal", Unseal::class.java) { ctx, req ->
            if (!ctx.hasPermission(Permission.systemUnseal()))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            val payloads = ArrayList(listOf(req.payload64))
            req.payloads64?.let { payloads.addAll(it) }

            val submitted = payloads.filterNotNull()

            if (submitted.isEmpty()) {
                throw TKeeperException(ErrorType.INVALID_REQUEST_BODY, "No unseal shares provided")
            }

            if (req.reset ?: false)
                keeper.reset()

            for (share in submitted) {
                val progress = keeper.submit(share)
                if (progress.ready) {
                    return@publicPost progress
                }
            }

            keeper.status().progress
        }

        sb.publicGet("/v1/keeper/system/unseal") { ctx ->
            if (!ctx.hasPermission(Permission.systemUnseal()))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            keeper.unseal()
        }

        sb.publicPostRaw("/v1/keeper/system/seal") { ctx ->
            if (!ctx.hasPermission(Permission.systemSeal()))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            keeper.seal()
            finishNoContent(ctx)
        }
    }
}