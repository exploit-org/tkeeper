package org.exploit.keeper.controller.external

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.crypto.KeeperCurve
import org.exploit.keeper.constant.permission.Permission
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.http.hasPermission
import org.exploit.keeper.model.request.Generate
import org.exploit.keeper.service.dkg.starter.DKGenerator
import org.exploit.keeper.util.validation.InputValidator

@Singleton
class KeyGenController(
    private val dkg: DKGenerator,
    private val support: ControllerSupport
) : ExternalController {

    override fun register(sb: ServerBuilder) = with(support) {
        sb.publicPost("/v1/keeper/dkg", Generate::class.java) { ctx, body ->
            if (!ctx.hasPermission(Permission.generateKey(body.mode)))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            val normalizedKeyId = body.keyId.trim()
                .lowercase()

            if (!InputValidator.isValidKeyId(normalizedKeyId))
                throw TKeeperException(ErrorType.INVALID_KEY_ID, normalizedKeyId)

            val normalizedAssetOwner = body.assetOwner?.trim()?.lowercase()

            normalizedAssetOwner?.let {
                if (!InputValidator.isValidAssetOwner(it))
                    throw TKeeperException(ErrorType.INVALID_ASSET_OWNER)
            }

            dkg.generateKey(
                keyId = normalizedKeyId,
                curve = KeeperCurve.fromName(body.curve),
                mode = body.mode,
                policy = body.policy,
                assetOwner = normalizedAssetOwner
            )

            finishOkJson(ctx)
        }
    }
}