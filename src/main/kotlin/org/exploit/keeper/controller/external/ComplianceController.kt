package org.exploit.keeper.controller.external

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.permission.Permission
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.http.hasPermission
import org.exploit.keeper.service.core.KeeperComplianceService
import kotlin.math.min

@Singleton
class ComplianceController(
    private val support: ControllerSupport,
    private val compliance: KeeperComplianceService
): ExternalController {
    override fun register(sb: ServerBuilder) {
        with(support) {
            sb.publicGet("/v1/keeper/compliance/inventory") { ctx ->
                if (!ctx.hasPermission(Permission.inventory()))
                    throw TKeeperException(ErrorType.ACCESS_DENIED)

                val logicalId = ctx.queryParam("logicalId")
                val historical = ctx.queryParam("historical")?.toBoolean() ?: false
                val lastSeen = ctx.queryParam("lastSeen")
                val assetOwner = ctx.queryParam("assetOwner")

                val limit = min(200, ctx.queryParam("limit")?.toIntOrNull() ?: 200)

               compliance.loadAssetInventory(historical, logicalId, assetOwner, lastSeen, limit)
            }
        }
    }
}