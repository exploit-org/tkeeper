package org.exploit.keeper.controller.external

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.permission.Permission
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.http.authData
import org.exploit.keeper.extension.http.hasPermission
import org.exploit.keeper.service.plane.KeeperControlPlaneService
import kotlin.math.min

@Singleton
class ControlPlaneController(
    private val support: ControllerSupport,
    private val controlPlane: KeeperControlPlaneService
): ExternalController {
    override fun register(sb: ServerBuilder) {
        with(support) {
            sb.publicGet("/v1/keeper/control/auth/config") {
                controlPlane.authConfig()
            }

            sb.publicGet("/v1/keeper/control/system") { ctx ->
                if (!ctx.hasPermission(Permission.controlSystem()))
                    throw TKeeperException(ErrorType.ACCESS_DENIED)

                controlPlane.system()
            }

            sb.publicGet("/v1/keeper/control/audit/sinks") { ctx ->
                if (!ctx.hasPermission(Permission.controlSinks()))
                    throw TKeeperException(ErrorType.ACCESS_DENIED)

                controlPlane.audit()
            }

            sb.publicGet("/v1/keeper/control/me") { ctx ->
                ctx.authData() ?: throw TKeeperException(ErrorType.UNAUTHENTICATED)
            }

            sb.publicGet("/v1/keeper/control/keys") { ctx ->
                val auth = ctx.authData() ?: throw TKeeperException(ErrorType.UNAUTHENTICATED)

                val historical = ctx.queryParam("historical")?.toBoolean() ?: false
                val logicalId = ctx.queryParam("logicalId")
                val lastSeen = ctx.queryParam("lastSeen")
                val assetOwner = ctx.queryParam("assetOwner")
                val limit = min(200, ctx.queryParam("limit")?.toIntOrNull() ?: 200)

                controlPlane.listKeysFor(auth, historical, assetOwner, logicalId, lastSeen, limit)
            }
        }
    }
}