package org.exploit.keeper.controller.external

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.permission.Permission
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.http.hasPermission
import org.exploit.keeper.model.audit.SignedLine
import org.exploit.keeper.model.request.Logs
import org.exploit.keeper.service.audit.verify.KeeperLogVerifier

@Singleton
class AuditController(
    private val support: ControllerSupport,
    private val verifier: KeeperLogVerifier
): ExternalController {
    override fun register(sb: ServerBuilder) = with(support) {
        sb.publicPost("/v1/keeper/audit/verify", SignedLine::class.java) { ctx, body ->
            if (!ctx.hasPermission(Permission.auditLogVerify()))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            verifier.verifyLine(body)
        }

        sb.publicPost("/v1/keeper/audit/verify/batch", Logs::class.java) { ctx, body ->
            if (!ctx.hasPermission(Permission.auditLogVerify()))
                throw TKeeperException(ErrorType.ACCESS_DENIED)

            verifier.verifyLines(body.logs)
        }
    }
}