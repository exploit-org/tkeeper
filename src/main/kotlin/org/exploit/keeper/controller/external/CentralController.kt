package org.exploit.keeper.controller.external

import com.linecorp.armeria.server.ServerBuilder
import com.linecorp.armeria.server.ServiceRequestContext
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.permission.Permission
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.extension.crypto.toBase64
import org.exploit.keeper.extension.http.hasPermission
import org.exploit.keeper.model.PublicKeyDto
import org.exploit.keeper.model.common.Value
import org.exploit.keeper.model.health.ShortStatus
import org.exploit.keeper.service.core.KeeperService
import org.exploit.keeper.service.pub.PublicKeyService

@Singleton
class CentralController(
    private val keeper: KeeperService,
    private val pub: PublicKeyService,
    private val support: ControllerSupport
) : ExternalController {
    override fun register(sb: ServerBuilder) = with(support) {
        sb.publicGet("/v1/keeper/ping") { _ ->
            val ready = keeper.initialized() && !keeper.sealed()
            ShortStatus(ready)
        }

        sb.publicGet("/v1/keeper/publicKey") { ctx: ServiceRequestContext ->
            val keyId = ctx.queryParam("keyId")
                ?: return@publicGet support.finishErrorJson(ctx, ErrorType.MISSING_KEY_ID)

            val generation = ctx.queryParam("generation")?.toIntOrNull()

            if (!ctx.hasPermission(Permission.keyGetPublicKey(keyId)))
                return@publicGet support.finishErrorJson(ctx, ErrorType.ACCESS_DENIED)

            keeper.ensureReady()

            val key = pub.getPublicKey(keyId, generation).data.toBase64()
            PublicKeyDto(key)
        }

        sb.publicGet("/v1/keeper/peerId") { _ ->
            keeper.ensureReady()
            val pid = keeper.peerId()

            Value(serviceId = pid, result = pid)
        }
    }
}