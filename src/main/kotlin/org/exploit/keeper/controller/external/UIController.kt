package org.exploit.keeper.controller.external

import com.linecorp.armeria.common.HttpResponse
import com.linecorp.armeria.common.ServerCacheControl
import com.linecorp.armeria.server.DecoratingHttpServiceFunction
import com.linecorp.armeria.server.ServerBuilder
import com.linecorp.armeria.server.file.FileService
import com.linecorp.armeria.server.file.HttpFile
import jakarta.inject.Singleton
import org.exploit.keeper.config.auth.AuthConfig
import org.exploit.keeper.config.csp.KeeperContentSecurityConfig
import org.exploit.keeper.config.keeper.KeeperConfig
import java.net.URI

@Singleton
class UIController(
    private val keeperConfig: KeeperConfig,
    private val authConfig: AuthConfig,
    private val csp: KeeperContentSecurityConfig
) : ExternalController {
    private val classLoader: ClassLoader = Thread.currentThread().contextClassLoader

    override fun register(sb: ServerBuilder) {
        val controlEnabled = System.getProperty(PROPERTY)?.toBoolean() ?: true
        if (!controlEnabled) return

        val cacheNo = ServerCacheControl.REVALIDATED
        val cacheAssets = ServerCacheControl.builder()
            .cachePublic()
            .maxAgeSeconds(31536000)
            .build()

        val index = HttpFile.builder(classLoader, "/ui/index.html")
            .cacheControl(cacheNo)
            .build()
            .asService()

        val pages = FileService.builder(classLoader, "/ui/pages")
            .cacheControl(cacheNo)
            .build()

        val assets = FileService.builder(classLoader, "/ui/assets")
            .cacheControl(cacheAssets)
            .serveCompressedFiles(true)
            .build()

        val (cspHeaderName, cspValue) = buildCspHeader(csp, authConfig)
        sb.decoratorUnder("/ui", securityHeaders(cspHeaderName, cspValue))

        sb.service("/ui/oidc/callback") { ctx, req -> index.serve(ctx, req) }
        sb.service("/ui") { _, _ -> HttpResponse.ofRedirect("/ui/") }
        sb.service("/ui/") { ctx, req -> index.serve(ctx, req) }
        sb.service("/ui/index.html") { ctx, req -> index.serve(ctx, req) }

        sb.serviceUnder("/ui/pages/", pages)
        sb.serviceUnder("/ui/assets/", assets)

        sb.serviceUnder("/ui/") { ctx, req ->
            val path = ctx.path()
            val hasExt = path.substringAfterLast('/', "").contains('.')
            if (hasExt) HttpResponse.of(404) else index.serve(ctx, req)
        }
    }

    private fun securityHeaders(cspHeader: String, cspValue: String): DecoratingHttpServiceFunction =
        DecoratingHttpServiceFunction { delegate, ctx, req ->
            ctx.addAdditionalResponseHeader(cspHeader, cspValue)
            ctx.addAdditionalResponseHeader("Referrer-Policy", "no-referrer")
            ctx.addAdditionalResponseHeader("X-Content-Type-Options", "nosniff")
            ctx.addAdditionalResponseHeader("X-Frame-Options", "DENY")
            ctx.addAdditionalResponseHeader("Permissions-Policy", "geolocation=(), microphone=(), camera=()")
            ctx.addAdditionalResponseHeader("Cross-Origin-Opener-Policy", "same-origin")
            ctx.addAdditionalResponseHeader("Cross-Origin-Resource-Policy", "same-origin")

            val tlsEnabled = keeperConfig.servers.public.tls
                ?.enabled == true

            if (tlsEnabled) {
                ctx.addAdditionalResponseHeader("Strict-Transport-Security", "max-age=31536000; includeSubDomains")
            }

            delegate.serve(ctx, req)
        }

    private fun buildCspHeader(
        c: KeeperContentSecurityConfig,
        auth: AuthConfig
    ): Pair<String, String> {
        val headerName = if (c.reportOnly) "Content-Security-Policy-Report-Only" else "Content-Security-Policy"

        fun normList(values: List<String>): List<String> =
            values.mapNotNull { normalizeSource(it) }.distinct()

        val connect = (c.connectSrc + c.connectExtra + if (c.oidcAutoConnect) originsFromAuth(auth) else emptyList())
        val form = (c.formAction + c.formActionExtra)
        val img = (c.imgSrc + c.imgExtra)

        val cspValue = listOf(
            "default-src ${normList(c.defaultSrc).joinToString(" ")}",
            "base-uri ${normList(c.baseUri).joinToString(" ")}",
            "object-src ${normList(c.objectSrc).joinToString(" ")}",
            "frame-ancestors ${normList(c.frameAncestors).joinToString(" ")}",
            "script-src ${normList(c.scriptSrc).joinToString(" ")}",
            "style-src ${normList(c.styleSrc).joinToString(" ")}",
            "img-src ${normList(img).joinToString(" ")}",
            "font-src ${normList(c.fontSrc).joinToString(" ")}",
            "connect-src ${normList(connect).joinToString(" ")}",
            "form-action ${normList(form).joinToString(" ")}",
        ).joinToString("; ") + ";"

        return headerName to cspValue
    }

    private fun originsFromAuth(auth: AuthConfig): List<String> {
        if (auth.type.lowercase() != "jwt") return emptyList()
        val jwt = auth.jwt ?: return emptyList()

        val out = mutableListOf<String>()
        jwt.oidc?.discoveryUrl?.let { originOrNull(it)?.let(out::add) }
        originOrNull(jwt.jwksLocation)?.let(out::add)

        return out.distinct()
    }

    private fun normalizeSource(raw: String?): String? {
        val s = raw?.trim().orEmpty()
        if (s.isEmpty()) return null
        if (s == "'self'" || s == "'none'" || s == "data:" || s == "blob:") return s

        return originOrNull(s)
    }

    private fun originOrNull(url: String): String? {
        val raw = url.trim()
        if (raw.isEmpty()) return null
        if (raw.startsWith("/")) return null

        val u = URI(raw)
        val scheme = u.scheme ?: return null
        val host = u.host ?: return null
        val port = u.port

        val isDefaultPort =
            (scheme == "https" && (port == 443 || port == -1)) ||
                    (scheme == "http" && (port == 80 || port == -1))

        return if (port == -1 || isDefaultPort) "$scheme://$host" else "$scheme://$host:$port"
    }

    private companion object {
        const val PROPERTY = "keeper.control.enabled"
    }
}