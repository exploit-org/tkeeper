package org.exploit.keeper.controller.external

import com.linecorp.armeria.common.HttpResponse
import com.linecorp.armeria.common.ServerCacheControl
import com.linecorp.armeria.server.ServerBuilder
import com.linecorp.armeria.server.file.FileService
import com.linecorp.armeria.server.file.HttpFile
import jakarta.inject.Singleton

@Singleton
class UIController: ExternalController {
    private val classLoader: ClassLoader = Thread.currentThread().contextClassLoader

    override fun register(sb: ServerBuilder) {
        val cacheNo = ServerCacheControl.REVALIDATED
        val cacheAssets = ServerCacheControl.builder()
            .cachePublic()
            .maxAgeSeconds(31536000)
            .build()

        val index = HttpFile.builder(classLoader, "/ui/index.html")
            .cacheControl(cacheNo)
            .build()
            .asService()

        val pages = FileService.builder(classLoader, "/ui/pages")
            .cacheControl(cacheNo)
            .build()

        val assets = FileService.builder(classLoader, "/ui/assets")
            .cacheControl(cacheAssets)
            .serveCompressedFiles(true)
            .build()

        sb.service("/ui/oidc/callback") { ctx, req -> index.serve(ctx, req) }
        sb.service("/ui") { _, _ -> HttpResponse.ofRedirect("/ui/") }
        sb.service("/ui/") { ctx, req -> index.serve(ctx, req) }
        sb.service("/ui/index.html") { ctx, req -> index.serve(ctx, req) }

        sb.serviceUnder("/ui/pages/", pages)
        sb.serviceUnder("/ui/assets/", assets)
        sb.serviceUnder("/ui/") { ctx, req ->
            val path = ctx.path()

            val hasExt = path.substringAfterLast('/', "")
                .contains('.')

            if (hasExt) HttpResponse.of(404) else index.serve(ctx, req)
        }
    }
}