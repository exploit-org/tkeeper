package org.exploit.keeper.controller.external

import com.linecorp.armeria.server.ServerBuilder
import jakarta.inject.Singleton
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.permission.Permission
import org.exploit.keeper.controller.support.ControllerSupport
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.extension.http.hasPermission
import org.exploit.keeper.service.core.KeeperConsistencyService

@Singleton
class ConsistencyController(
    private val support: ControllerSupport,
    private val consistency: KeeperConsistencyService
): ExternalController {
    override fun register(sb: ServerBuilder) {
        with(support) {
            sb.publicPost("/v1/keeper/consistency/fix") { ctx ->
                if (!ctx.hasPermission(Permission.consistencyFix()))
                    throw TKeeperException(ErrorType.ACCESS_DENIED)

                val keyId = ctx.queryParam("keyId")
                    ?: throw TKeeperException(ErrorType.MISSING_KEY_ID)

                consistency.tryAutoFix(keyId)
            }
        }
    }
}