package org.exploit.keeper.factory

import com.fasterxml.jackson.databind.ObjectMapper
import io.micronaut.context.annotation.Factory
import jakarta.inject.Singleton
import org.eclipse.jetty.util.ssl.SslContextFactory
import org.exploit.jettyx.Jettyx
import org.exploit.jettyx.http2.Http2Version
import org.exploit.jettyx.jackson.JacksonHttpMapper
import org.exploit.keeper.api.client.TKeeperClient
import org.exploit.keeper.config.keeper.KeeperConfig
import org.exploit.keeper.db.RocksKeyDB
import org.exploit.keeper.extension.messagePackMapper
import org.exploit.keeper.service.auth.jettyx.KeeperJettyxAuthenticator
import org.exploit.keeper.service.boot.KeeperBootService
import org.exploit.keeper.service.integrity.KeeperSignatureService
import java.util.concurrent.Executors

@Factory
class JettyxFactory(private val config: KeeperConfig) {
    @Singleton
    fun internalJettyx(): Jettyx {
        return buildJettyx(messagePackMapper)
    }

    @Singleton
    fun clients(
        msgPackJettyx: Jettyx,
        db: RocksKeyDB,
        signer: KeeperSignatureService,
        boot: KeeperBootService
    ): List<TKeeperClient> =
        config.peers.map { peer ->
            TKeeperClient(
                peerId = peer.id,
                auth = KeeperJettyxAuthenticator(peer.id, db, signer, boot),
                url = peer.internalUrl,
                internalClient = msgPackJettyx
            )
        }

    private fun buildJettyx(objectMapper: ObjectMapper): Jettyx {
        val builder = Jettyx.newBuilder()
            .enableVersion(Http2Version())
            .addHttpMapper(JacksonHttpMapper.create(objectMapper))
            .executor(Executors.newVirtualThreadPerTaskExecutor())
            .customize {
                it.idleTimeout = config.client.idleTimeout
                it.connectTimeout = config.client.connectTimeout
            }

        val clientConfig = config.client

        if (clientConfig.tls) {
            val sslContext = SslContextFactory.Client()
            sslContext.trustStorePath = clientConfig.trustStorePath
                ?: throw IllegalArgumentException("keeper.sslTrustStorePath must be set while keeper.ssl.enabled is set to true")

            sslContext.setTrustStorePassword(clientConfig.trustStorePassword
                ?: throw IllegalArgumentException("keeper.ssl.trust-store-password must be set while keeper.ssl.enabled is set to true"))
        }

        return builder.build()
    }
}