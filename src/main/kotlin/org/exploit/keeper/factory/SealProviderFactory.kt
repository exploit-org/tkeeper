package org.exploit.keeper.factory

import io.micronaut.context.annotation.Factory
import jakarta.inject.Singleton
import org.exploit.keeper.config.keeper.KeeperConfig
import org.exploit.keeper.service.core.seal.provider.AwsCloudProvider
import org.exploit.keeper.service.core.seal.provider.GoogleCloudProvider
import org.exploit.keeper.service.core.seal.provider.SealProvider
import org.exploit.keeper.service.core.seal.provider.ShamirKeysProvider
import org.exploit.sodium.ReadOnlyBuffer

@Factory
class SealProviderFactory {
    @Singleton
    fun createProvider(config: KeeperConfig, key: ReadOnlyBuffer): SealProvider? {
        return when (config.seal.selected) {
            ShamirKeysProvider.ID -> requireNotNull(config.seal.shamir).let {
                ShamirKeysProvider(key, it.total, it.threshold)
            }

            AwsCloudProvider.ID -> AwsCloudProvider(requireNotNull(config.seal.aws))

            GoogleCloudProvider.ID -> GoogleCloudProvider(requireNotNull(config.seal.google))

            else -> error("Unsupported seal provider type: ${config.seal.selected}")
        }
    }
}