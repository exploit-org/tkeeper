package org.exploit.keeper.factory

import io.micronaut.context.annotation.Factory
import jakarta.inject.Singleton
import org.exploit.keeper.config.auth.AuthConfig
import org.exploit.keeper.config.dev.DevConfig
import org.exploit.keeper.service.auth.external.DevMachineAuthenticator
import org.exploit.keeper.service.auth.external.ExternalRequestAuthenticator
import org.exploit.keeper.service.auth.external.JwtMachineAuthenticator
import java.time.Duration
import java.util.*

@Factory
class AuthenticatorFactory(
    private val authConfig: AuthConfig,
    private val devConfig: Optional<DevConfig>
) {
    @Singleton
    fun authenticator(): ExternalRequestAuthenticator {
        return when (authConfig.type.lowercase()) {
            "jwt" -> {
                val jwt = authConfig.jwt ?: error("auth.jwt must be set when auth.type=jwt")
                JwtMachineAuthenticator(
                    jwksLocation = jwt.jwksLocation,
                    refreshDuration = jwt.refresh ?: Duration.ofMinutes(15)
                )
            }
            "dev" -> devConfig.map { DevMachineAuthenticator(it) }
                .orElseThrow { IllegalStateException("DevConfig must be provided when auth.type=dev") }

            else -> error("Unsupported auth.type=${authConfig.type}")
        }
    }
}