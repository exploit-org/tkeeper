package org.exploit.keeper

import io.micronaut.context.ApplicationContext
import io.micronaut.context.env.Environment
import org.exploit.tss.TSS
import org.slf4j.Logger
import org.slf4j.LoggerFactory
import kotlin.system.exitProcess

private val LOGGER: Logger = LoggerFactory.getLogger("TKeeper")

private fun loadNativeLibraries() {
    try {
        TSS.loadLibraries()
    } catch (_: UnsatisfiedLinkError) {
        LOGGER.warn("Failed to load bundled native libs, linux-aarch64?")
        LOGGER.warn("Loading libs from system path")

        System.loadLibrary("sodium")
        System.loadLibrary("secp256k1")
        System.loadLibrary("gmp")
    }
}

fun main(args: Array<String>) {
    loadNativeLibraries()

    val ctx: ApplicationContext = try {
        ApplicationContext.builder(*args)
            .eagerInitSingletons(true)
            .environments(Environment.CLOUD, Environment.BARE_METAL)
            .start()
    } catch (t: Throwable) {
        t.printStackTrace()
        exitProcess(1)
    }

    val launcher = ctx.getBean(ServerLauncher::class.java)

    Runtime.getRuntime().addShutdownHook(Thread {
        try { launcher.stop() } catch (_: Exception) {}
        try { ctx.close() } catch (_: Exception) {}
    })

    try {
        launcher.start()
        launcher.blockUntilShutdown()
    } catch (t: Throwable) {
        t.printStackTrace()
        try { ctx.close() } catch (_: Exception) {}
        exitProcess(1)
    }
}