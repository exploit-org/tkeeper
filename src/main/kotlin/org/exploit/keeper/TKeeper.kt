package org.exploit.keeper

import io.micronaut.context.ApplicationContext
import io.micronaut.context.env.Environment
import org.exploit.tss.TSS
import kotlin.system.exitProcess

fun main(args: Array<String>) {
    TSS.loadLibraries()

    val ctx: ApplicationContext = try {
        ApplicationContext.builder(*args)
            .eagerInitSingletons(true)
            .environments(Environment.CLOUD, Environment.BARE_METAL)
            .start()
    } catch (t: Throwable) {
        t.printStackTrace()
        exitProcess(1)
    }

    val launcher = ctx.getBean(ServerLauncher::class.java)

    Runtime.getRuntime().addShutdownHook(Thread {
        try { launcher.stop() } catch (_: Exception) {}
        try { ctx.close() } catch (_: Exception) {}
    })

    try {
        launcher.start()
        launcher.blockUntilShutdown()
    } catch (t: Throwable) {
        t.printStackTrace()
        try { ctx.close() } catch (_: Exception) {}
        exitProcess(1)
    }
}