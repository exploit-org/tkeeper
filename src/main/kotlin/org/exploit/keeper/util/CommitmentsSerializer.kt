package org.exploit.keeper.util

import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.crypto.CurveName
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.model.keygen.DkgCommitments
import java.nio.ByteBuffer

object CommitmentsSerializer {
    private const val VERSION: Int = 1

    fun serialize(commitments: DkgCommitments): ByteArray =
        serialize(commitments.curve, commitments.commitments)

    fun serialize(curve: CurveName, commitments: List<ByteArray>): ByteArray {
        val size =
            4 +
            4 + curve.name.toByteArray(Charsets.UTF_8).size +
            4 +
            commitments.sumOf { 4 + it.size }

        val buf = ByteBuffer.allocate(size)
        buf.putInt(VERSION)

        val curveBytes = curve.name.toByteArray(Charsets.UTF_8)
        buf.putInt(curveBytes.size)
        buf.put(curveBytes)

        buf.putInt(commitments.size)
        for (c in commitments) {
            buf.putInt(c.size)
            buf.put(c)
        }

        return buf.array()
    }

    fun deserialize(raw: ByteArray): DkgCommitments {
        val buf = ByteBuffer.wrap(raw)

        val v = buf.int
        require(v == VERSION) { "Unsupported commitments version=$v" }

        val curveLen = buf.int
        require(curveLen in 1..4096) { "Bad curveLen=$curveLen" }

        val curveBytes = ByteArray(curveLen)
        buf.get(curveBytes)
        val curve = CurveName.fromName(String(curveBytes, Charsets.UTF_8))
            ?: throw TKeeperException(ErrorType.INTERNAL_ERROR, "Commitment deserializer returned unsupported curve")

        val count = buf.int
        require(count in 1..1024) { "Bad commitments count=$count" }

        val commits = ArrayList<ByteArray>(count)
        repeat(count) {
            val len = buf.int
            require(len in 1..(1 shl 20)) { "Bad commitment len=$len" }
            val b = ByteArray(len)
            buf.get(b)
            commits.add(b)
        }

        return DkgCommitments(curve, commits)
    }
}