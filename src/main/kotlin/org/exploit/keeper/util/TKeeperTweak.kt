package org.exploit.keeper.util

import org.exploit.gmp.BigInt
import org.exploit.keeper.constant.common.ErrorType
import org.exploit.keeper.constant.crypto.CurveName
import org.exploit.keeper.exception.TKeeperException
import org.exploit.keeper.util.validation.InputValidator
import org.exploit.tss.util.Bytes
import java.nio.ByteBuffer
import java.nio.charset.StandardCharsets

object TKeeperTweak {
    private const val DEFAULT_HASH_ALGORITHM = "SHA-512"

    private val DST_TWEAK = "TKEEPER-TWEAK-XMD-v1".toByteArray(StandardCharsets.US_ASCII)
    private val PREFIX = "tkeeper-tweak-v1".toByteArray(StandardCharsets.US_ASCII)

    private const val SEP: Byte = 0

    fun tweakScalar(
        curve: CurveName,
        keyId: ByteArray,
        tweak: String,
        order: BigInt,
        hashAlg: String = DEFAULT_HASH_ALGORITHM
    ): BigInt {
        val ctx = normalizeContext(tweak)
        val msg = encodeMsg(keyId, curve, ctx)

        return HashToScalar.hashToScalarXmd(hashAlg, DST_TWEAK, msg, order).mod(order)
    }

    fun tweak(ski: BigInt, keyId: ByteArray, curve: CurveName, tweak: String, order: BigInt, hashAlg: String = DEFAULT_HASH_ALGORITHM): BigInt {
        val t = tweakScalar(curve, keyId, tweak, order, hashAlg)
        return ski.mod(order).add(t).mod(order)
    }

    fun normalizeContext(tweak: String): ByteArray {
        val s = tweak.trim().lowercase()

        if (s.isEmpty())
            throw TKeeperException(ErrorType.INVALID_TWEAK)

        if (!InputValidator.isValidTweak(s))
            throw TKeeperException(ErrorType.INVALID_TWEAK)

        return s.toByteArray(StandardCharsets.US_ASCII)
    }

    fun encodeMsg(keyId: ByteArray, curve: CurveName, normalizedCtx: ByteArray): ByteArray {
        return Bytes.concat(
            PREFIX, byteArrayOf(SEP),
            byteArrayOf(curve.id),
            u32be(keyId.size), keyId,
            u32be(normalizedCtx.size), normalizedCtx
        )
    }


    private fun u32be(v: Int): ByteArray = ByteBuffer.allocate(4)
        .putInt(v)
        .array()
}