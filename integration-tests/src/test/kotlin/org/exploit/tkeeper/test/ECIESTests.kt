package org.exploit.tkeeper.test

import org.exploit.tkeeper.sdk.model.*
import org.exploit.tkeeper.test.compose.ComposeEnvironment
import org.exploit.tkeeper.test.compose.KeeperComposeFactory
import org.junit.jupiter.api.*
import org.testcontainers.junit.jupiter.Container
import org.testcontainers.junit.jupiter.Testcontainers
import java.util.*
import kotlin.test.assertEquals

@Testcontainers
@TestMethodOrder(MethodOrderer.OrderAnnotation::class)
class ECIESTests: TKeeperComposeEnvironment() {
    override val env: ComposeEnvironment = dockerEnvironment

    @Test
    @Order(1)
    fun prepareKey() {
        bootstrap()

        assertDoesNotThrow {
            client(1).dkg().generate(Generate(ECIES_TEST_KEY, CurveName.SECP256K1, KeyGenMode.CREATE))
        }
    }

    @Test
    @Order(2)
    fun encryptDecryptSuccessful() {
        val msg = b64(MESSAGE.toByteArray())

        val result = assertDoesNotThrow {
            client(2).ecies().encrypt(Encrypt(ECIES_TEST_KEY, CipherType.AES_GCM, msg))
        }

        val decrypted = assertDoesNotThrow {
            client(1).ecies().decrypt(Decrypt(ECIES_TEST_KEY, CipherType.AES_GCM, result.ciphertext64))
        }

        assertEquals(msg, decrypted.plaintext64())
    }

    private fun b64(data: ByteArray): String =
        Base64.getEncoder().encodeToString(data)

    companion object {
        const val ECIES_TEST_KEY = "ecies-test-key"
        const val MESSAGE = "Hello, Keeper!"

        @Container
        @JvmField
        val dockerEnvironment = KeeperComposeFactory.newEnv()
    }
}