package org.exploit.tkeeper.test

import org.exploit.tkeeper.sdk.TKeeperClient
import org.exploit.tkeeper.sdk.auth.DevTokenAuth
import org.exploit.tkeeper.sdk.model.KeeperInitData
import org.exploit.tkeeper.sdk.model.StoreState
import org.exploit.tkeeper.sdk.model.initdata.ShamirInitData
import org.exploit.tkeeper.test.compose.ComposeEnvironment
import org.junit.jupiter.api.BeforeAll
import org.junit.jupiter.api.TestInstance
import kotlin.test.assertTrue

@TestInstance(TestInstance.Lifecycle.PER_CLASS)
abstract class TKeeperComposeEnvironment {
    protected abstract val env: ComposeEnvironment

    private val devToken = requireNotNull(System.getProperty("it.dev.token"))

    private val clients = mutableMapOf<String, TKeeperClient>()
    protected val shares: MutableMap<Int, List<String>> = HashMap()

    protected fun client(peerId: Int): TKeeperClient {
        require(peerId in 1..3) { "Invalid peer id: $peerId" }
        return client("keeper-$peerId")
    }

    protected fun client(service: String): TKeeperClient =
        clients.getOrPut(service) {
            TKeeperClient(baseUrl(service), DevTokenAuth(devToken))
        }

    @BeforeAll
    fun bootstrap() {
        initIfNeeded(service = "keeper-1", peerId = 1)
        initIfNeeded(service = "keeper-2", peerId = 2)
        initIfNeeded(service = "keeper-3", peerId = 3)

        (1..3).forEach { peer ->
            assertTrue(client(peer).system().ready(), "keeper-$peer is not ready")
        }
    }

    private fun initIfNeeded(service: String, peerId: Int) {
        val k = client(service)
        if (k.system().status().state == StoreState.UNINITIALIZED) {
            val r = k.system().init(KeeperInitData(peerId, 2, 3)) as ShamirInitData
            shares[peerId] = r.shares64()
        }
    }

    private fun baseUrl(service: String): String {
        val host = env.getServiceHost(service, 8080)
        val port = env.getServicePort(service, 8080)
        return "http://$host:$port"
    }
}