package org.exploit.tkeeper.test

import org.exploit.tkeeper.sdk.model.Unseal
import org.exploit.tkeeper.test.compose.ComposeEnvironment
import org.exploit.tkeeper.test.compose.KeeperComposeFactory
import org.junit.jupiter.api.*
import org.testcontainers.junit.jupiter.Container
import org.testcontainers.junit.jupiter.Testcontainers
import kotlin.test.assertNotNull
import kotlin.test.assertTrue

@Testcontainers
@TestMethodOrder(MethodOrderer.OrderAnnotation::class)
class SealManagerTests: TKeeperComposeEnvironment() {
    override val env: ComposeEnvironment = dockerEnvironment

    @Test
    @Order(1)
    fun sealNotThrows() {
        assertDoesNotThrow { client(1).system().seal() }
        assertDoesNotThrow { client(2).system().seal() }
        assertDoesNotThrow { client(3).system().seal() }
    }

    @Test
    @Order(2)
    fun unsealSuccessful() {
        val k1 = assertDoesNotThrow {
            client(1).system().unseal(Unseal(assertNotNull(shares[1]).take(3).shuffled()))
        }

        val k2 = assertDoesNotThrow {
            client(2).system().unseal(Unseal(assertNotNull(shares[2]).take(3).shuffled()))
        }

        val k3 = assertDoesNotThrow {
            client(3).system().unseal(Unseal(assertNotNull(shares[3]).take(3).shuffled()))
        }

        assertTrue { k1.ready() && k2.ready() && k3.ready() }
    }

    companion object {
        @Container
        @JvmField
        val dockerEnvironment = KeeperComposeFactory.newEnv()
    }
}