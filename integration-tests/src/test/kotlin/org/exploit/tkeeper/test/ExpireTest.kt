package org.exploit.tkeeper.test

import org.exploit.tkeeper.sdk.model.*
import org.exploit.tkeeper.test.compose.ComposeEnvironment
import org.exploit.tkeeper.test.compose.KeeperComposeFactory
import org.junit.jupiter.api.Assertions.*
import org.junit.jupiter.api.MethodOrderer
import org.junit.jupiter.api.Order
import org.junit.jupiter.api.Test
import org.junit.jupiter.api.TestMethodOrder
import org.testcontainers.junit.jupiter.Container
import org.testcontainers.junit.jupiter.Testcontainers
import java.time.Instant

@Testcontainers
@TestMethodOrder(MethodOrderer.OrderAnnotation::class)
class ExpireTest : TKeeperComposeEnvironment() {
    override val env: ComposeEnvironment = dockerEnvironment

    @Test
    @Order(1)
    fun prepareKeys() {
        val now = Instant.now()

        generateWithPolicy(KEY_ID_30, now.plusSeconds(86400 * EXPIRE_30), now.plusSeconds(86400 * EXPIRE_30 + 10), KeyGenMode.CREATE)
        generateWithPolicy(KEY_ID_7,  now.plusSeconds(86400 * EXPIRE_7),  now.plusSeconds(86400 * EXPIRE_7 + 10),  KeyGenMode.CREATE)
        generateWithPolicy(KEY_ID_1,  now.plusSeconds(86400 * EXPIRE_1),  now.plusSeconds(86400 * EXPIRE_1 + 10),  KeyGenMode.CREATE)
    }

    @Test
    @Order(2)
    fun applyWindowReturnsAllThree() {
        val windowSec = 86400L * 40
        val all = listAllApply(windowSec = windowSec, limit = 2)
            .filter { it.logicalId.startsWith(TEST_KEY_ID_PREFIX) }

        val ids = all.map { it.logicalId }.toSet()
        assertEquals(setOf(KEY_ID_30, KEY_ID_7, KEY_ID_1), ids)

        all.forEach {
            assertEquals(ExpireType.APPLY, it.type)
            assertEquals(1, it.generation)
            assertTrue(it.expiresAt > 0)
        }
    }

    @Test
    @Order(3)
    fun applyWindowFiltersBySmallerWindow() {
        val windowSec = 86400L * 10
        val all = listAllApply(windowSec = windowSec, limit = 2)
            .filter { it.logicalId.startsWith(TEST_KEY_ID_PREFIX) }

        val ids = all.map { it.logicalId }.toSet()
        assertEquals(setOf(KEY_ID_7, KEY_ID_1), ids)
    }

    @Test
    @Order(4)
    fun processPaginates() {
        val windowSec = 86400L * 40

        val page0 = client(1).expire().listProcess(windowSec, 1, null)
        assertEquals(1, page0.items().size)
        assertNotNull(page0.next())

        val page1 = client(1).expire().listProcess(windowSec, 10, page0.next())
        val all = (page0.items() + page1.items())
            .filter { it.logicalId.startsWith(TEST_KEY_ID_PREFIX) }

        val ids = all.map { it.logicalId }.toSet()
        assertEquals(setOf(KEY_ID_30, KEY_ID_7, KEY_ID_1), ids)

        all.forEach {
            assertEquals(ExpireType.PROCESS, it.type)
            assertEquals(1, it.generation)
        }
    }

    @Test
    @Order(5)
    fun rotateRemovesPrevApplyButKeepsProcess() {
        val now = Instant.now()

        generateWithPolicy(
            KEY_ID_30,
            now.plusSeconds(86400 * EXPIRE_30),
            now.plusSeconds(86400 * EXPIRE_30 + 10),
            KeyGenMode.ROTATE
        )

        val windowSec = 86400L * 40

        val applyAll = listAllApply(windowSec = windowSec, limit = 2)
            .filter { it.logicalId == KEY_ID_30 }

        assertTrue { applyAll.any { it.generation == 2 } }
        assertTrue { applyAll.none { it.generation == 1 } }

        val processAll = listAllProcess(windowSec = windowSec, limit = 2)
            .filter { it.logicalId == KEY_ID_30 }

        assertTrue(processAll.any { it.generation == 1 })
        assertTrue(processAll.any { it.generation == 2 })
    }

    @Test
    @Order(6)
    fun expiredReturnsExpiredItems() {
        val keyId = TEST_KEY_ID.format("expired")

        val now = Instant.now()
        generateWithPolicy(
            keyId,
            now.plusSeconds(2),
            now.plusSeconds(3),
            KeyGenMode.CREATE
        )

        Thread.sleep(5000)

        val expiredApply = listAllExpired(ExpireType.APPLY, limit = 10)
            .filter { it.logicalId == keyId }

        val expiredProcess = listAllExpired(ExpireType.PROCESS, limit = 10)
            .filter { it.logicalId == keyId }

        assertTrue { expiredApply.isNotEmpty() }
        assertTrue { expiredProcess.isNotEmpty() }

        expiredApply.forEach { assertEquals(ExpireType.APPLY, it.type) }
        expiredProcess.forEach { assertEquals(ExpireType.PROCESS, it.type) }
    }

    private fun listAllApply(windowSec: Long, limit: Int): List<ExpireItem> {
        val out = ArrayList<ExpireItem>()
        var cursor: String? = null

        while (true) {
            val page = client(1).expire().listApply(windowSec, limit, cursor)
            out += page.items()
            cursor = page.next()
            if (cursor == null) break
        }

        return out
    }

    private fun listAllProcess(windowSec: Long, limit: Int): List<ExpireItem> {
        val out = ArrayList<ExpireItem>()
        var cursor: String? = null

        while (true) {
            val page = client(1).expire().listProcess(windowSec, limit, cursor)
            out += page.items()
            cursor = page.next()
            if (cursor == null) break
        }

        return out
    }

    private fun listAllExpired(type: ExpireType, limit: Int): List<ExpireItem> {
        val out = ArrayList<ExpireItem>()
        var cursor: String? = null

        while (true) {
            val page = client(1).expire().listExpired(type, limit, cursor)
            out += page.items()
            cursor = page.next()
            if (cursor == null) break
        }

        return out
    }

    private fun generateWithPolicy(keyId: String, expireApply: Instant, expireProcess: Instant, mode: KeyGenMode) {
        val apply = NotAfter(TimestampUnit.SECONDS, expireApply.epochSecond)
        val process = NotAfter(TimestampUnit.SECONDS, expireProcess.epochSecond)

        val policy = KeySetPolicy(apply, process)
        val request = Generate(keyId, CurveName.SECP256K1, mode, policy)

        assertDoesNotThrow { client(1).dkg().generate(request) }
    }

    companion object {
        const val EXPIRE_30 = 30L
        const val EXPIRE_7 = 7L
        const val EXPIRE_1 = 1L

        private const val TEST_KEY_ID_PREFIX = "test-expires-key-secp256k1-"
        const val TEST_KEY_ID = "$TEST_KEY_ID_PREFIX%s"

        val KEY_ID_30 = TEST_KEY_ID.format(EXPIRE_30)
        val KEY_ID_7 = TEST_KEY_ID.format(EXPIRE_7)
        val KEY_ID_1 = TEST_KEY_ID.format(EXPIRE_1)

        @Container
        @JvmField
        val dockerEnvironment = KeeperComposeFactory.newEnv()
    }
}