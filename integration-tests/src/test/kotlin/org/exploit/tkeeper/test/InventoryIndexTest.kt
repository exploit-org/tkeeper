package org.exploit.tkeeper.test

import org.exploit.tkeeper.sdk.model.CurveName
import org.exploit.tkeeper.sdk.model.Generate
import org.exploit.tkeeper.sdk.model.KeyGenMode
import org.exploit.tkeeper.test.compose.ComposeEnvironment
import org.exploit.tkeeper.test.compose.KeeperComposeFactory
import org.junit.jupiter.api.*
import org.testcontainers.junit.jupiter.Container
import org.testcontainers.junit.jupiter.Testcontainers
import kotlin.test.assertTrue

@Testcontainers
@TestMethodOrder(MethodOrderer.OrderAnnotation::class)
class InventoryIndexTest: TKeeperComposeEnvironment() {
    override val env: ComposeEnvironment = dockerEnvironment

    @Test
    @Order(1)
    fun prepareKeys() {
        val generateOwner = Generate(
            KEY_OWNER_ID,
            CurveName.SECP256K1,
            KeyGenMode.CREATE,
            OWNER
        )

        val generateNotOwner = Generate(
            KEY_NOT_OWNER_ID,
            CurveName.SECP256K1,
            KeyGenMode.CREATE,
        )

        assertDoesNotThrow { client(1).dkg().generate(generateOwner) }
        assertDoesNotThrow { client(1).dkg().generate(generateNotOwner) }
    }

    @Test
    @Order(2)
    fun ensureInventoryReturnsOwnerKeys() {
        for (i in 1..3) {
            assertTrue {
                client(i).compliance().inventoryForOwner(OWNER)
                    .inventory()
                    .items()
                    .all { it.assetOwner() == OWNER }
            }
        }
    }

    companion object {
        const val KEY_OWNER_ID = "test-owner"
        const val KEY_NOT_OWNER_ID = "test-not-owner"
        const val OWNER = "owner"

        @Container
        @JvmField
        val dockerEnvironment = KeeperComposeFactory.newEnv()
    }
}