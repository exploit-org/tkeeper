package org.exploit.tkeeper.test

import org.exploit.ed25519.Ed25519
import org.exploit.secp256k1.Secp256k1
import org.exploit.tkeeper.sdk.model.CurveName
import org.exploit.tkeeper.sdk.model.Store
import org.exploit.tkeeper.test.compose.ComposeEnvironment
import org.exploit.tkeeper.test.compose.KeeperComposeFactory
import org.exploit.tss.TSS
import org.junit.jupiter.api.BeforeAll
import org.junit.jupiter.api.Test
import org.junit.jupiter.api.assertDoesNotThrow
import org.testcontainers.junit.jupiter.Container
import org.testcontainers.junit.jupiter.Testcontainers
import java.util.*
import kotlin.test.assertEquals

@Testcontainers
class KeyImportTests: TKeeperComposeEnvironment() {
    override val env: ComposeEnvironment = dockerEnvironment

    @Test
    fun secp256k1ImportSuccessfulAndMatchesPublicKey() {
        val randomSecp256k1KeyPair = Secp256k1.generateKeyPair()
        val publicKey = b64(randomSecp256k1KeyPair.publicKey)
        val privateKey = b64(randomSecp256k1KeyPair.secretKey)

        import(SECP256K1_KEY, CurveName.SECP256K1, privateKey)

        val extractedPublicKey = client(1).central().getPublicKey(SECP256K1_KEY)
        assertEquals(publicKey, extractedPublicKey.data64())
    }

    @Test
    fun ed25519ImportSuccessfulAndMatchesPublicKey() {
        val randomEd25519KeyPair = Ed25519.generateKeyPair()
        val publicKey = b64(randomEd25519KeyPair.publicKey)
        val privateKey = b64(randomEd25519KeyPair.secretKey)

        import(ED25519_KEY, CurveName.ED25519, privateKey)

        val extractedPublicKey = client(1).central().getPublicKey(ED25519_KEY)
        assertEquals(publicKey, extractedPublicKey.data64())
    }

    private fun import(keyId: String, curve: CurveName, privateKey: String) {
        val importRequest = Store(keyId, curve, privateKey)
        assertDoesNotThrow { client(1).storage().store(importRequest) }
    }

    private fun b64(data: ByteArray) = Base64.getEncoder().encodeToString(data)

    companion object {
        @Container
        @JvmField
        val dockerEnvironment = KeeperComposeFactory.newEnv()

        const val SECP256K1_KEY = "secp256k1-import"
        const val ED25519_KEY = "ed25519-import"

        @BeforeAll
        @JvmStatic
        fun initTss4j() {
            TSS.loadLibraries()
        }
    }
}