package org.exploit.tkeeper.sdk.modules;

import org.eclipse.jetty.http.HttpMethod;
import org.exploit.jettyx.Jettyx;
import org.exploit.jettyx.annotation.Body;
import org.exploit.jettyx.annotation.ContentType;
import org.exploit.jettyx.annotation.HttpRequest;
import org.exploit.jettyx.auth.Authorization;
import org.exploit.jettyx.model.HttpResponse;
import org.exploit.tkeeper.sdk.annotation.Description;
import org.exploit.tkeeper.sdk.model.Logs;
import org.exploit.tkeeper.sdk.model.SignedLine;
import org.exploit.tkeeper.sdk.model.VerifyResult;

import java.util.Map;

import static org.exploit.tkeeper.sdk.util.KeeperUtils.handleError;

public final class AuditModule {
    private final AuditApi api;

    private interface AuditApi {
        @Description("Verify single Audit log")
        @HttpRequest(method = HttpMethod.POST, path = "/v1/keeper/audit/verify")
        @ContentType("application/json")
        HttpResponse<VerifyResult> verify(@Body SignedLine request);

        @Description("Verify multiple Audit logs")
        @HttpRequest(method = HttpMethod.POST, path = "/v1/keeper/audit/verify/batch")
        @ContentType("application/json")
        HttpResponse<Map<String, VerifyResult>> verifyBatch(@Body Logs request);
    }

    public AuditModule(Jettyx jettyx, String baseUrl, Authorization auth) {
        this.api = jettyx.newApiClient(baseUrl, auth).create(AuditApi.class);
    }

    public VerifyResult verify(SignedLine request) {
        var resp = api.verify(request);
        handleError(resp);

        return resp.body();
    }

    public Map<String, VerifyResult> verifyBatch(Logs request) {
        var resp = api.verifyBatch(request);
        handleError(resp);

        return resp.body();
    }
}