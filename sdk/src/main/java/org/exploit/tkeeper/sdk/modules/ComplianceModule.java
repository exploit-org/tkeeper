package org.exploit.tkeeper.sdk.modules;

import org.eclipse.jetty.http.HttpMethod;
import org.exploit.jettyx.Jettyx;
import org.exploit.jettyx.annotation.HttpRequest;
import org.exploit.jettyx.annotation.Query;
import org.exploit.jettyx.auth.Authorization;
import org.exploit.jettyx.model.HttpResponse;
import org.exploit.tkeeper.sdk.annotation.Description;
import org.exploit.tkeeper.sdk.model.AssetInventoryPage;

import static org.exploit.tkeeper.sdk.util.KeeperUtils.handleError;

public final class ComplianceModule {
    private final ComplianceApi api;

    private interface ComplianceApi {
        @Description("Get inventory of assets")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/compliance/inventory")
        HttpResponse<AssetInventoryPage> inventory(
                @Query("logicalId") String logicalId,
                @Query("historical") Boolean historical,
                @Query("lastSeen") String lastSeen,
                @Query("assetOwner") String assetOwner,
                @Query("limit") Integer limit);
    }

    public ComplianceModule(Jettyx jettyx, String baseUrl, Authorization auth) {
        this.api = jettyx.newApiClient(baseUrl, auth).create(ComplianceApi.class);
    }

    public AssetInventoryPage inventoryForOwner(String assetOwner) {
        return inventoryForOwner(assetOwner, null, null);
    }

    public AssetInventoryPage inventoryForOwner(String assetOwner, Integer limit) {
        return inventoryForOwner(assetOwner, null, limit);
    }

    public AssetInventoryPage inventoryForOwner(String assetOwner, String lastSeen) {
        return inventoryForOwner(assetOwner, lastSeen, null);
    }

    public AssetInventoryPage inventoryForOwner(String assetOwner, String lastSeen, Integer limit) {
        return inventory(null, false, lastSeen, assetOwner, limit);
    }

    public AssetInventoryPage inventory(int limit) {
        return inventory(null, limit);
    }

    public AssetInventoryPage inventory(String lastSeen, Integer limit) {
        return inventory(null, null, lastSeen, limit);
    }

    public AssetInventoryPage inventory(String logicalId, Boolean historical, String lastSeen, Integer limit) {
        return inventory(logicalId, historical, lastSeen, null, limit);
    }

    public AssetInventoryPage inventory(String logicalId, Boolean historical, String lastSeen, String assetOwner, Integer limit) {
        var resp = api.inventory(logicalId, historical, lastSeen, assetOwner, limit);
        handleError(resp);

        return resp.body();
    }
}