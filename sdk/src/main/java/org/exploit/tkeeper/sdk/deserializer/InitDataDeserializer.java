package org.exploit.tkeeper.sdk.deserializer;

import com.fasterxml.jackson.core.JacksonException;
import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.DeserializationContext;
import com.fasterxml.jackson.databind.JsonDeserializer;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import org.exploit.tkeeper.sdk.model.initdata.EmptyInitData;
import org.exploit.tkeeper.sdk.model.initdata.InitData;
import org.exploit.tkeeper.sdk.model.initdata.ShamirInitData;

import java.io.IOException;
import java.util.List;

public class InitDataDeserializer extends JsonDeserializer<InitData> {
    @Override
    public InitData deserialize(JsonParser jsonParser, DeserializationContext deserializationContext) throws IOException, JacksonException {
        var mapper = (ObjectMapper) jsonParser.getCodec();
        var tree = mapper.readTree(jsonParser);

        if (tree.isMissingNode())
            return EmptyInitData.INSTANCE;

        var objectNode = (ObjectNode) tree;

        if (objectNode.has("shares64")) {
            var threshold = objectNode.get("threshold").asInt();
            var total = objectNode.get("total").asInt();
            var shares64 = mapper.treeToValue(objectNode.get("shares64"), new TypeReference<List<String>>() {});

            return new ShamirInitData(threshold, total, shares64);
        }

        throw new IllegalArgumentException("Invalid init data returned by TKeeper");
    }
}
