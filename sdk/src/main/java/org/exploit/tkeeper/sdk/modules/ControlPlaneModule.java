package org.exploit.tkeeper.sdk.modules;

import org.eclipse.jetty.http.HttpMethod;
import org.exploit.jettyx.Jettyx;
import org.exploit.jettyx.annotation.HttpRequest;
import org.exploit.jettyx.annotation.Query;
import org.exploit.jettyx.auth.Authorization;
import org.exploit.jettyx.model.HttpResponse;
import org.exploit.tkeeper.sdk.annotation.Description;
import org.exploit.tkeeper.sdk.model.*;
import org.exploit.tkeeper.sdk.model.System;

import static org.exploit.tkeeper.sdk.util.KeeperUtils.handleError;

public final class ControlPlaneModule {
    private final ControlPlaneApi api;

    private interface ControlPlaneApi {
        @Description("Get auth configuration for control plane")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/control/auth/config")
        HttpResponse<ControlPlaneAuthConfig> getAuthConfig();

        @Description("Fetch system status across peers in control plane.")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/control/system")
        HttpResponse<System> getSystem();

        @Description("Get enabled audit sinks statuses")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/control/audit/sinks")
        HttpResponse<AuditInfo> getAuditSinks();

        @Description("Get current authenticated user info")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/control/me")
        HttpResponse<SimpleAuthData> getMe();

        @Description("List keys to which user has at least 1 operational permission (sign/encrypt..)")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/control/keys")
        HttpResponse<AllowedKeySetPage> listKeys(
                @Query("historical") Boolean historical,
                @Query("logicalId") String logicalId,
                @Query("lastSeen") String lastSeen,
                @Query("limit") Integer limit);
    }

    public ControlPlaneModule(Jettyx jettyx, String baseUrl, Authorization auth) {
        this.api = jettyx.newApiClient(baseUrl, auth).create(ControlPlaneApi.class);
    }

    public ControlPlaneAuthConfig getAuthConfig() {
        var resp = api.getAuthConfig();
        handleError(resp);
        return resp.body();
    }

    public System getSystem() {
        var resp = api.getSystem();
        handleError(resp);
        return resp.body();
    }

    public AuditInfo getAuditSinks() {
        var resp = api.getAuditSinks();
        handleError(resp);
        return resp.body();
    }

    public SimpleAuthData getMe() {
        var resp = api.getMe();
        handleError(resp);
        return resp.body();
    }

    public AllowedKeySetPage listKeys(Boolean historical, String logicalId, String lastSeen, Integer limit) {
        var resp = api.listKeys(historical, logicalId, lastSeen, limit);
        handleError(resp);
        return resp.body();
    }
}