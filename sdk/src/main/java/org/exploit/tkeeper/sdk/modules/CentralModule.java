package org.exploit.tkeeper.sdk.modules;

import org.eclipse.jetty.http.HttpMethod;
import org.exploit.jettyx.Jettyx;
import org.exploit.jettyx.annotation.HttpRequest;
import org.exploit.jettyx.annotation.Query;
import org.exploit.jettyx.auth.Authorization;
import org.exploit.jettyx.model.HttpResponse;
import org.exploit.tkeeper.sdk.annotation.Description;
import org.exploit.tkeeper.sdk.model.PublicKeyDto;
import org.exploit.tkeeper.sdk.model.ShortStatus;
import org.exploit.tkeeper.sdk.model.ValueInt;

import static org.exploit.tkeeper.sdk.util.KeeperUtils.handleError;

public final class CentralModule {
    private final CentralApi api;

    private interface CentralApi {
        @Description("Ping the central server. Returns ready = true, if unsealed & initialized")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/ping")
        HttpResponse<ShortStatus> ping();

        @Description("Get public key by keyId")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/publicKey")
        HttpResponse<PublicKeyDto> publicKey(@Query("keyId") String keyId, @Query("generation") Integer generation);

        @Description("Get peerId")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/peerId")
        HttpResponse<ValueInt> peerId();
    }

    public CentralModule(Jettyx jettyx, String baseUrl, Authorization auth) {
        this.api = jettyx.newApiClient(baseUrl, auth).create(CentralApi.class);
    }

    public ShortStatus ping() {
        var resp = api.ping();
        handleError(resp);
        return resp.body();
    }

    public PublicKeyDto getPublicKey(String keyId, Integer generation) {
        var resp = api.publicKey(keyId, generation);
        handleError(resp);
        return resp.body();
    }

    public PublicKeyDto getPublicKey(String keyId) {
        return getPublicKey(keyId, null);
    }

    public int getPeerId() {
        var resp = api.peerId();
        handleError(resp);
        return resp.body().result();
    }
}