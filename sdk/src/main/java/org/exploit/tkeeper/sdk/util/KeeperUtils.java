package org.exploit.tkeeper.sdk.util;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.exploit.jettyx.model.HttpResponse;
import org.exploit.tkeeper.sdk.exception.TKeeperException;
import org.exploit.tkeeper.sdk.model.ErrorMessage;

import java.io.UncheckedIOException;

public final class KeeperUtils {
    private KeeperUtils() {
    }

    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();

    public static void handleError(HttpResponse<?> resp) {
        if (resp == null) {
            return;
        }
        var status = resp.status();
        if (status < 200 || status >= 300) {
            var raw = resp.rawResponse();
            if (raw != null) {
                try {
                    var errorMsg = OBJECT_MAPPER.readValue(raw.getContentAsString(), ErrorMessage.class);
                    throw new TKeeperException(errorMsg.error(), errorMsg.details());
                } catch (JsonProcessingException e) {
                    throw new UncheckedIOException(e);
                }
            }

            throw new IllegalStateException("Unexpected response status and no error message returned" + status);
        }
    }

    public static ObjectMapper getObjectMapper() {
        return OBJECT_MAPPER;
    }
}
