package org.exploit.tkeeper.sdk.modules;

import org.eclipse.jetty.http.HttpMethod;
import org.exploit.jettyx.Jettyx;
import org.exploit.jettyx.annotation.HttpRequest;
import org.exploit.jettyx.annotation.Query;
import org.exploit.jettyx.auth.Authorization;
import org.exploit.jettyx.model.HttpResponse;
import org.exploit.tkeeper.sdk.annotation.Description;
import org.exploit.tkeeper.sdk.model.ExpireItem;
import org.exploit.tkeeper.sdk.model.ExpireType;
import org.exploit.tkeeper.sdk.model.Page;
import org.exploit.tkeeper.sdk.util.KeeperUtils;

import java.util.Objects;

public class ExpireModule {
    private final ExpireApi api;

    private interface ExpireApi {
        @Description("List keys, 'type' operations of which will be expired in specific window seconds or in period 'from' <-> 'to'")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/expires")
        HttpResponse<Page<ExpireItem, String>> list(
                @Query("type") String type,
                @Query("windowSec") Long windowSec,
                @Query("from") Long from,
                @Query("to") Long to,
                @Query("limit") Integer limit,
                @Query("cursor") String cursor
        );

        @Description("List keys, which 'APPLY' type operations will be expired in a specific window seconds")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/expires/apply")
        HttpResponse<Page<ExpireItem, String>> listApply(
                @Query("windowSec") Long windowSec,
                @Query("limit") Integer limit,
                @Query("cursor") String cursor
        );

        @Description("List keys, which 'PROCESS' type operations will be expired in a specific window seconds")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/expires/process")
        HttpResponse<Page<ExpireItem, String>> listProcess(
                @Query("windowSec") Long windowSec,
                @Query("limit") Integer limit,
                @Query("cursor") String cursor
        );

        @Description("List expired keys")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/expires/expired")
        HttpResponse<Page<ExpireItem, String>> listExpired(
                @Query("type") String type,
                @Query("limit") Integer limit,
                @Query("cursor") String cursor
        );
    }

    public ExpireModule(Jettyx jettyx, String baseUrl, Authorization auth) {
        this.api = jettyx.newApiClient(baseUrl, auth).create(ExpireApi.class);
    }

    public Page<ExpireItem, String> list(
            ExpireType type,
            Long windowSec,
            Long from,
            Long to,
            Integer limit,
            String cursor
    ) {
        Objects.requireNonNull(type, "type");

        var resp = api.list(type.toQuery(), windowSec, from, to, limit, cursor);

        KeeperUtils.handleError(resp);
        return resp.body();
    }

    public Page<ExpireItem, String> listWindow(ExpireType type, long windowSec, int limit, String cursor) {
        return list(type, windowSec, null, null, limit, cursor);
    }

    public Page<ExpireItem, String> listWindow(ExpireType type, long windowSec, int limit) {
        return listWindow(type, windowSec, limit, null);
    }

    public Page<ExpireItem, String> listRange(ExpireType type, long from, long to, int limit, String cursor) {
        return list(type, null, from, to, limit, cursor);
    }

    public Page<ExpireItem, String> listRange(ExpireType type, long from, long to, int limit) {
        return listRange(type, from, to, limit, null);
    }

    public Page<ExpireItem, String> listApply(long windowSec, int limit, String cursor) {
        var resp = api.listApply(windowSec, limit, cursor);
        KeeperUtils.handleError(resp);
        return resp.body();
    }

    public Page<ExpireItem, String> listApply(long windowSec, int limit) {
        return listApply(windowSec, limit, null);
    }

    public Page<ExpireItem, String> listProcess(long windowSec, int limit, String cursor) {
        var resp = api.listProcess(windowSec, limit, cursor);
        KeeperUtils.handleError(resp);
        return resp.body();
    }

    public Page<ExpireItem, String> listProcess(long windowSec, int limit) {
        return listProcess(windowSec, limit, null);
    }

    public Page<ExpireItem, String> listExpired(ExpireType type, int limit, String cursor) {
        Objects.requireNonNull(type, "type");

        var resp = api.listExpired(type.toQuery(), limit, cursor);
        KeeperUtils.handleError(resp);
        return resp.body();
    }

    public Page<ExpireItem, String> listExpired(ExpireType type, int limit) {
        return listExpired(type, limit, null);
    }

    public Page<ExpireItem, String> listExpiredApply(int limit, String cursor) {
        return listExpired(ExpireType.APPLY, limit, cursor);
    }

    public Page<ExpireItem, String> listExpiredProcess(int limit, String cursor) {
        return listExpired(ExpireType.PROCESS, limit, cursor);
    }
}