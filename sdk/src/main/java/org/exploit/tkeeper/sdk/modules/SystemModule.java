package org.exploit.tkeeper.sdk.modules;

import org.eclipse.jetty.http.HttpMethod;
import org.exploit.jettyx.Jettyx;
import org.exploit.jettyx.annotation.Body;
import org.exploit.jettyx.annotation.ContentType;
import org.exploit.jettyx.annotation.HttpRequest;
import org.exploit.jettyx.auth.Authorization;
import org.exploit.jettyx.model.HttpResponse;
import org.exploit.tkeeper.sdk.annotation.Description;
import org.exploit.tkeeper.sdk.model.KeeperInitData;
import org.exploit.tkeeper.sdk.model.StatusResponse;
import org.exploit.tkeeper.sdk.model.Unseal;
import org.exploit.tkeeper.sdk.model.initdata.InitData;
import org.exploit.tkeeper.sdk.model.progress.Progress;

import static org.exploit.tkeeper.sdk.util.KeeperUtils.handleError;

public final class SystemModule {
    private final SystemApi api;

    private interface SystemApi {
        @Description("Get system status")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/system/status")
        HttpResponse<StatusResponse> status();

        @Description("Initialize Keeper")
        @HttpRequest(method = HttpMethod.POST, path = "/v1/keeper/system/init")
        @ContentType("application/json")
        HttpResponse<InitData> init(@Body KeeperInitData request);

        @Description("Check Keeper health. Throws exception if not healthy.")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/system/health")
        HttpResponse<Void> health();

        @Description("Check Keeper readiness. Throws exception if sealed/uninitialized.")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/system/ready")
        HttpResponse<Void> ready();

        @Description("Unseal Keeper with Shamir Shares")
        @HttpRequest(method = HttpMethod.POST, path = "/v1/keeper/system/unseal")
        @ContentType("application/json")
        HttpResponse<Progress> unseal(@Body Unseal request);

        @Description("Unseal Keeper when auto KeyOps are used")
        @HttpRequest(method = HttpMethod.GET, path = "/v1/keeper/system/unseal")
        HttpResponse<Progress> unseal();

        @Description("Seal Keeper")
        @HttpRequest(method = HttpMethod.POST, path = "/v1/keeper/system/seal")
        HttpResponse<Void> seal();
    }

    public SystemModule(Jettyx jettyx, String baseUrl, Authorization auth) {
        this.api = jettyx.newApiClient(baseUrl, auth).create(SystemApi.class);
    }

    public StatusResponse status() {
        var resp = api.status();
        handleError(resp);
        return resp.body();
    }

    public InitData init(KeeperInitData request) {
        var resp = api.init(request);
        handleError(resp);
        return resp.body();
    }

    public boolean healthy() {
        try {
            var resp = api.health();
            return resp.status() == 204;
        } catch (Exception e) {
            return false;
        }
    }

    public boolean ready() {
        var resp = api.ready();
        return resp.status() == 204;
    }

    public Progress unseal(Unseal request) {
        var resp = api.unseal(request);
        handleError(resp);
        return resp.body();
    }

    public void seal() {
        var resp = api.seal();
        handleError(resp);
    }
}