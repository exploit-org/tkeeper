package org.exploit.tkeeper.sdk.deserializer;

import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.databind.DeserializationContext;
import com.fasterxml.jackson.databind.JsonDeserializer;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import org.exploit.tkeeper.sdk.model.progress.Progress;
import org.exploit.tkeeper.sdk.model.progress.ReadyProgress;
import org.exploit.tkeeper.sdk.model.progress.ShamirUnsealProgress;

import java.io.IOException;

public class ProgressDeserializer extends JsonDeserializer<Progress> {
    @Override
    public Progress deserialize(JsonParser jsonParser, DeserializationContext deserializationContext) throws IOException {
        var mapper = (ObjectMapper) jsonParser.getCodec();
        var tree = (ObjectNode) mapper.readTree(jsonParser);

        if (!tree.has("ready"))
            throw new IllegalArgumentException("Invalid progress returned by TKeeper");

        var ready = tree.get("ready").asBoolean();

        if (tree.has("threshold") && tree.has("total") && tree.has("progress")) {
            var threshold = tree.get("threshold").asInt();
            var total = tree.get("total").asInt();
            var progress = tree.get("progress").asInt();

            return new ShamirUnsealProgress(threshold, total, progress, ready);
        }

        return new ReadyProgress(ready);
    }
}
