package org.exploit.tkeeper.sdk.modules;

import org.eclipse.jetty.http.HttpMethod;
import org.exploit.jettyx.Jettyx;
import org.exploit.jettyx.annotation.HttpRequest;
import org.exploit.jettyx.annotation.Query;
import org.exploit.jettyx.auth.Authorization;
import org.exploit.jettyx.model.HttpResponse;
import org.exploit.tkeeper.sdk.annotation.Description;
import org.exploit.tkeeper.sdk.model.ConsistencyCheck;

import static org.exploit.tkeeper.sdk.util.KeeperUtils.handleError;

public final class ConsistencyModule {
    private final ConsistencyApi api;

    private interface ConsistencyApi {
        @Description("Try auto-fix key consistency across peers when INCONSISTENT_KEEPER error is returned.")
        @HttpRequest(method = HttpMethod.POST, path = "/v1/keeper/consistency/fix")
        HttpResponse<ConsistencyCheck> fix(@Query("keyId") String keyId);
    }

    public ConsistencyModule(Jettyx jettyx, String baseUrl, Authorization auth) {
        this.api = jettyx.newApiClient(baseUrl, auth).create(ConsistencyApi.class);
    }

    public ConsistencyCheck fix(String keyId) {
        var resp = api.fix(keyId);
        handleError(resp);
        return resp.body();
    }
}